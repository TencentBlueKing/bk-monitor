{"ops":[{"insert":"这是一个基于 Monaco Editor（VS Code 使用的代码编辑器）开发的 Prometheus PromQL（Prometheus Query Language）查询编辑器组件，主要用于在 Web 应用中提供专业的 PromQL 语法高亮、自动补全、错误提示等功能的代码编辑体验。\n\n基本用途"},{"attributes":{"header":1},"insert":"\n"},{"insert":"\n该组件旨在为前端应用（如 Grafana 类似的监控系统、自定义 Prometheus 查询页面等）提供一个开箱即用的、功能完整的 PromQL 查询编辑器，包括：\n- 语法高亮（基于 Lezer 解析器）\n- 自动补全（关键字、函数、操作符等）\n- 错误检测与提示（通过 Monaco 的 Marker 系统）\n- 支持主题切换、只读模式、高度自适应等\n- 提供丰富的配置项和事件回调（如 onChange、onFocus、onBlur、executeQuery 等）\n\n主要功能"},{"attributes":{"header":1},"insert":"\n"},{"insert":"\n1. PromQL 语言支持"},{"attributes":{"header":2},"insert":"\n"},{"insert":"- 定义了 PromQL 作为 Monaco Editor 的一种语言（通过 `monaco-promql.ts` 中的 `promLanguageDefinition` 注册）。\n- 支持 PromQL 相关的文件扩展名（如 `.promql`）和别名（如 Prometheus、promql 等）。\n\n2. 编辑器 UI 组件"},{"attributes":{"header":2},"insert":"\n"},{"insert":"- 主要封装在 `promql-editor.tsx` 中，是一个类似 Vue 的 TSX 组件（使用了 vue-property-decorator 和 vue-tsx-support）。\n- 提供完整的编辑器 UI，包括：\n  - 可调整大小的边框（右下角拖拽调整高度）\n  - 占位符提示（当编辑器为空时显示提示信息）\n  - 错误状态样式（边框变红、显示错误提示 Marker）\n  - 支持自定义主题、尺寸、是否只读等\n\n3. 语法解析与错误检查"},{"attributes":{"header":2},"insert":"\n"},{"insert":"- 使用第三方库 `@prometheus-io/lezer-promql`（基于 Lezer）进行 PromQL 语法解析。\n- 在用户输入后对查询语句进行语法校验，提取错误位置并在编辑器中通过 Marker 显示出来（红色波浪线 + 错误信息 tooltip）。\n- 错误校验逻辑主要在 `validation.ts` 中实现，包括错误节点定位、错误信息格式化等。\n\n4. 智能提示（自动补全）"},{"attributes":{"header":2},"insert":"\n"},{"insert":"- 提供 PromQL 相关的关键字、内置函数（如 sum、avg、rate、increase 等）、操作符（如 and、or、== 等）、时间范围（如 1m、5m、1h）、聚合操作等自动补全建议。\n- 补全逻辑定义在 `promql.ts` 的 `completionItemProvider` 中，支持按上下文触发（比如输入 `[` 时优先提示 duration 类型）。\n\n5. 交互与事件"},{"attributes":{"header":2},"insert":"\n"},{"insert":"- 支持多种用户交互事件，例如：\n  - onChange：内容发生变化时触发\n  - onFocus / onBlur：获得/失去焦点\n  - executeQuery：当用户按下 Enter（且无补全建议时）触发查询动作\n  - 支持 Shift+Enter 换行\n- 提供丰富的配置选项，如高度、宽度、主题、字体、是否只读、自定义样式类等。\n\n6. Monaco Editor 配置封装"},{"attributes":{"header":2},"insert":"\n"},{"insert":"- 在 `promql.ts` 中定义了 PromQL 语言的配置，包括：\n  - 关键字、操作符、函数列表\n  - 词法分析规则（tokenizer）、自动闭合括号、代码折叠等\n  - 语言配置（languageConfiguration）和补全提供器（completionItemProvider）\n\n文件职责说明"},{"attributes":{"header":1},"insert":"\n"},{"insert":"\n| 文件 | 主要作用 |\n|------|----------|\n| monaco-promql.ts | 注册 PromQL 语言到 Monaco Editor，定义语言 ID、别名、扩展名等元信息 |\n| promql-editor.tsx | 核心编辑器 React/Vue 组件，封装了 Monaco Editor 的初始化、事件处理、UI 交互、样式、错误提示、自动调整大小等功能 |\n| promql.ts | 定义 PromQL 语言的语法规则、关键字、内置函数、自动补全逻辑、语言配置等 |\n| types.ts | 定义编辑器相关组件的 TypeScript 类型，如事件处理器、构造参数、配置对象等，便于类型安全开发 |\n| validation.ts | 实现 PromQL 查询语句的语法校验逻辑，解析错误节点并转换为编辑器可显示的错误边界和提示信息 |\n| promql-editor.scss | 编辑器的样式文件，定义了编辑器外观、错误状态、占位符、调整大小手柄等样式 |\n\n使用方法"},{"attributes":{"header":1},"insert":"\n"},{"attributes":{"code-block":"plain"},"insert":"\n"},{"insert":"<template>"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"  <PromqlMonacoEditor"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    v-model=\"query\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    :height=\"'300px'\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    :is-error=\"hasError\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    :execute-query=\"runQuery\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    @change=\"onQueryChange\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    @blur=\"onQueryBlur\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    @focus=\"onQueryFocus\""},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"  />"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"</template>"},{"attributes":{"code-block":"vue"},"insert":"\n\n"},{"insert":"<script lang=\"ts\">"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"import PromqlMonacoEditor from './path-to/promql-editor.tsx';"},{"attributes":{"code-block":"vue"},"insert":"\n\n"},{"insert":"export default {"},{"attributes":{"code-block":"plain"},"insert":"\n"},{"insert":"  components: { PromqlMonacoEditor },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"  data() {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    return {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"      query: 'up{job=\"node\"}',"},{"attributes":{"code-block":"plain"},"insert":"\n"},{"insert":"      hasError: false,"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    };"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"  },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"  methods: {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    runQuery(hasValidationPassed: boolean) {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"      if (hasValidationPassed) {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"        console.log('执行查询:', this.query);"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"      }"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    onQueryChange(value: string) {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"      this.query = value;"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    onQueryBlur(value: string, hasErr: boolean) {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"      this.hasError = hasErr;"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    onQueryFocus() {"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"      console.log('编辑器获得焦点');"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"    },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"  },"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"};"},{"attributes":{"code-block":"vue"},"insert":"\n"},{"insert":"</script>"},{"attributes":{"code-block":"vue"},"insert":"\n\n"},{"insert":"\nProps 说明"},{"attributes":{"header":1},"insert":"\n"},{"insert":"\n| 参数 | 说明 |\n|------|------|\n| value / defaultValue | 编辑器的初始值或受控值 |\n| height / width | 编辑器尺寸 |\n| theme | 编辑器主题，如 'vs', 'dark' |\n| language | 语言 ID，一般传 'promql' |\n| readonly | 是否只读 |\n| isError | 是否显示错误样式（红框） |\n| executeQuery | 当用户按下 Enter 且无补全时触发的查询回调 |\n| onChange | 内容变化时的回调 |\n| onFocus / onBlur | 聚焦/失焦回调 |\n| options | 传递给 Monaco Editor 的额外配置项 |\n| className | 自定义编辑器容器样式类 |\n\n总结"},{"attributes":{"header":1},"insert":"\n"},{"insert":"\n这是一个功能完备、专业性强的 PromQL 语法专用代码编辑器前端组件，适合集成到任何需要用户输入和编辑 Prometheus 查询语句的 Web 应用中，尤其是监控面板、运维平台、可观测性系统等场景。\n它封装了从语法解析、错误检查、智能提示到 UI 交互、样式美化等方方面面，开发者可以非常方便地以“即插即用”的方式将其引入项目，提升用户在编写 PromQL 时的体验和准确性。\n"}],"extra":{"updator":"Austin","update_at":"2026-01-21 17:11:04"}}