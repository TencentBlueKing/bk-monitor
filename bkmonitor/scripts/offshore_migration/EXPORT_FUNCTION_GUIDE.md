# ç›‘æ§é…ç½®å¯¼å‡ºåŠŸèƒ½å®Œæ•´å­¦ä¹ æ–‡æ¡£

## ğŸ“š ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
4. [é…ç½®ç³»ç»Ÿ](#é…ç½®ç³»ç»Ÿ)
5. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
6. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
7. [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
10. [é™„å½•](#é™„å½•)

---

## åŠŸèƒ½æ¦‚è¿°

### 1.1 èƒŒæ™¯

ç›‘æ§é…ç½®å¯¼å‡ºåŠŸèƒ½æ˜¯ä¸ºäº†æ”¯æŒè“é²¸ç›‘æ§å¹³å°çš„**è·¨ç¯å¢ƒæ•°æ®è¿ç§»**éœ€æ±‚è€Œå¼€å‘çš„ã€‚å½“é¡¹ç›®éœ€è¦å‡ºæµ·ã€è¿ç§»åˆ°æ–°ç¯å¢ƒæˆ–è¿›è¡Œæ•°æ®å¤‡ä»½æ—¶ï¼Œéœ€è¦å°†é…ç½®æ•°æ®ï¼ˆå¦‚å‘Šè­¦ç­–ç•¥ã€ä»ªè¡¨ç›˜ã€é‡‡é›†é…ç½®ç­‰ï¼‰ä»æºç¯å¢ƒå¯¼å‡ºï¼Œå¹¶åœ¨ç›®æ ‡ç¯å¢ƒå¯¼å…¥ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½

- âœ… **å¤šèµ„æºç±»å‹å¯¼å‡º**ï¼šæ”¯æŒ 12 ç§èµ„æºç±»å‹çš„å¯¼å‡º
- âœ… **æ•°æ®é€‚é…è½¬æ¢**ï¼šè‡ªåŠ¨å¤„ç†åŸŸåã€ä¸šåŠ¡IDã€ç”¨æˆ·ä¿¡æ¯ç­‰ç¯å¢ƒå·®å¼‚
- âœ… **å…³ç³»æ•°æ®å¯¼å‡º**ï¼šè‡ªåŠ¨å¯¼å‡ºå…³è”çš„ä¾èµ–æ•°æ®
- âœ… **JSON åºåˆ—åŒ–**ï¼šå®‰å…¨å¤„ç† datetimeã€Decimalã€set ç­‰ç‰¹æ®Šç±»å‹
- âœ… **ID æ˜ å°„ç®¡ç†**ï¼šè®°å½•åŸå§‹IDï¼Œä¾¿äºå¯¼å…¥æ—¶é‡å»ºå…³ç³»
- âœ… **æ•°æ®éªŒè¯**ï¼šç¡®ä¿å¯¼å‡ºæ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

### 1.3 æ”¯æŒçš„èµ„æºç±»å‹

| èµ„æºç±»å‹ | è¯´æ˜ | å…³è”æ•°æ® |
|---------|------|---------|
| `strategy` | å‘Šè­¦ç­–ç•¥ | Itemã€Detectã€Algorithm |
| `user_group` | å‘Šè­¦ç»„ | DutyArrangeã€DutyRule |
| `duty_rule` | è½®å€¼è§„åˆ™ | - |
| `action_config` | å¤„ç†å¥—é¤ | - |
| `action_plugin` | å“åº”åŠ¨ä½œæ’ä»¶ | - |
| `alert_assign_group` | å‘Šè­¦åˆ†æ´¾ç»„ | AlertAssignRule |
| `shield` | å‘Šè­¦å±è”½ | - |
| `dashboard` | ä»ªè¡¨ç›˜ | - |
| `collect_config` | æ•°æ®é‡‡é›†é…ç½® | CollectorPlugin |
| `collector_plugin` | é‡‡é›†æ’ä»¶ | - |
| `custom_ts_table` | è‡ªå®šä¹‰æ—¶åºè¡¨ | CustomTSField |
| `custom_ts_group` | è‡ªå®šä¹‰æ—¶åºåˆ†ç»„ | - |

---

## æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ConfigExporter                       â”‚
â”‚              (ä¸»å¯¼å‡ºæ§åˆ¶å™¨)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AdapterManager â”‚   â”‚   IDMapper      â”‚
â”‚ (é€‚é…å™¨ç®¡ç†)    â”‚   â”‚  (IDæ˜ å°„ç®¡ç†)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                    â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚DomainAdapterâ”‚  â”‚BizIDAdapter  â”‚  â”‚UserAdapter  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  BaseExporter   â”‚
         â”‚  (åŸºç¡€å¯¼å‡ºå™¨)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Strategyâ”‚  â”‚Dashboard  â”‚  â”‚Collect â”‚
â”‚Exporterâ”‚  â”‚Exporter   â”‚  â”‚Exporterâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
2. **é€‚é…å™¨æ¨¡å¼**ï¼šé€šè¿‡é€‚é…å™¨å¤„ç†ç¯å¢ƒå·®å¼‚ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
3. **å¯é…ç½®æ€§**ï¼šæ‰€æœ‰è¡Œä¸ºé€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
4. **ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†èµ„æºé—´çš„ä¾èµ–å…³ç³»ï¼Œç¡®ä¿å¯¼å‡ºé¡ºåºæ­£ç¡®
5. **æ•°æ®å®Œæ•´æ€§**ï¼šé€šè¿‡éªŒè¯å™¨ç¡®ä¿å¯¼å‡ºæ•°æ®çš„æ­£ç¡®æ€§

### 2.3 æ ¸å¿ƒè®¾è®¡æ¨¡å¼

- **é€‚é…å™¨æ¨¡å¼**ï¼š`AdapterManager` + å„ç§ `Adapter`
- **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒçš„å¯¼å‡ºå™¨å®ç°ä¸åŒçš„å¯¼å‡ºç­–ç•¥
- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼š`BaseExporter` å®šä¹‰å¯¼å‡ºæµç¨‹ï¼Œå­ç±»å®ç°å…·ä½“é€»è¾‘
- **å·¥å‚æ¨¡å¼**ï¼š`EXPORTER_REGISTRY` æ³¨å†Œå’Œç®¡ç†å¯¼å‡ºå™¨

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 3.1 ConfigExporterï¼ˆä¸»å¯¼å‡ºæ§åˆ¶å™¨ï¼‰

**ä½ç½®**ï¼š`scripts/export_config.py`

**èŒè´£**ï¼š
- åŠ è½½å’Œè§£æé…ç½®æ–‡ä»¶
- åˆå§‹åŒ–é€‚é…å™¨ç®¡ç†å™¨å’ŒIDæ˜ å°„å™¨
- åè°ƒå„ä¸ªå¯¼å‡ºå™¨çš„æ‰§è¡Œ
- ç”Ÿæˆæœ€ç»ˆçš„å¯¼å‡ºç»“æœæ–‡ä»¶

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```python
class ConfigExporter:
    def __init__(self, config_file=None, config_dict=None)
    def export_all(self) -> dict
    def save_to_file(self, output_file=None) -> str
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
from scripts.offshore_migration.export_config import ConfigExporter

# æ–¹å¼1: ä½¿ç”¨é…ç½®æ–‡ä»¶
exporter = ConfigExporter(config_file="export_config.yaml")

# æ–¹å¼2: ä½¿ç”¨é…ç½®å­—å…¸
config = {
  "export": {"bk_biz_ids": [100, 101]},
  "adapters": {"biz_id_mapping": {"auto": True}}
}
exporter = ConfigExporter(config_dict=config)

# æ‰§è¡Œå¯¼å‡º
result = exporter.export_all()
output_file = exporter.save_to_file()
```

### 3.2 BaseExporterï¼ˆåŸºç¡€å¯¼å‡ºå™¨ï¼‰

**ä½ç½®**ï¼š`scripts/export_base.py`

**èŒè´£**ï¼š
- å®šä¹‰å¯¼å‡ºå™¨çš„é€šç”¨æ¥å£å’Œæµç¨‹
- æä¾›æ¨¡å‹åˆ°å­—å…¸çš„è½¬æ¢
- å¤„ç†æŸ¥è¯¢è¿‡æ»¤
- ç®¡ç†IDæ˜ å°„

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```python
class BaseExporter:
    def query_objects(self, bk_biz_ids=None) -> QuerySet
    def export(self, bk_biz_ids=None) -> List[dict]
    def export_object(self, obj) -> dict
    def export_relations(self, obj, data: dict) -> dict
```

**å¯¼å‡ºæµç¨‹**ï¼š

```
1. query_objects()     â†’ æŸ¥è¯¢è¦å¯¼å‡ºçš„å¯¹è±¡
2. export_object()     â†’ å°†å¯¹è±¡è½¬æ¢ä¸ºå­—å…¸
3. export_relations()  â†’ å¯¼å‡ºå…³è”å¯¹è±¡
4. apply_adapters()    â†’ åº”ç”¨é€‚é…å™¨è½¬æ¢
5. record_id_mapping()  â†’ è®°å½•IDæ˜ å°„å…³ç³»
```

### 3.3 AdapterManagerï¼ˆé€‚é…å™¨ç®¡ç†å™¨ï¼‰

**ä½ç½®**ï¼š`scripts/export_adapters.py`

**èŒè´£**ï¼š
- ç®¡ç†æ‰€æœ‰é€‚é…å™¨çš„ç”Ÿå‘½å‘¨æœŸ
- æŒ‰é¡ºåºåº”ç”¨é€‚é…å™¨
- æ ¹æ®é…ç½®åŠ¨æ€å¯ç”¨/ç¦ç”¨é€‚é…å™¨

**é€‚é…å™¨æ‰§è¡Œé¡ºåº**ï¼š

```
1. TimestampAdapter      â†’ è½¬æ¢ datetime ä¸ºæ—¶é—´æˆ³
2. DomainAdapter          â†’ æ›¿æ¢åŸŸåï¼ˆå¦‚æœé…ç½®ï¼‰
3. UserInfoAdapter        â†’ å¤„ç†ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœé…ç½®ï¼‰
4. BizIDAdapter           â†’ å¤„ç†ä¸šåŠ¡IDï¼ˆå¦‚æœé…ç½®ï¼‰
5. SensitiveFieldAdapter  â†’ å¤„ç†æ•æ„Ÿå­—æ®µï¼ˆå¦‚æœé…ç½®ï¼‰
6. JSONFieldAdapter       â†’ é€’å½’å¤„ç†JSONå­—æ®µ
```

### 3.4 é€‚é…å™¨è¯¦è§£

#### 3.4.1 TimestampAdapterï¼ˆæ—¶é—´æˆ³é€‚é…å™¨ï¼‰

**ä½œç”¨**ï¼šå°† `datetime` å¯¹è±¡è½¬æ¢ä¸º Unix æ—¶é—´æˆ³ï¼ˆæ•´æ•°ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# è½¬æ¢å‰
{"create_time": datetime(2025, 1, 19, 12, 0, 0)}

# è½¬æ¢å
{"create_time": 1737269400}
```

#### 3.4.2 DomainAdapterï¼ˆåŸŸåé€‚é…å™¨ï¼‰

**ä½œç”¨**ï¼šæ›¿æ¢æ•°æ®ä¸­çš„åŸŸå

**é…ç½®**ï¼š
```yaml
domain_mapping:
  "https://old-domain.com": "https://new-domain.com"
  "http://test.com": "${NEW_DOMAIN}"  # æ”¯æŒç¯å¢ƒå˜é‡
```

**å¤„ç†é€»è¾‘**ï¼š
- é€’å½’éå†æ‰€æœ‰å­—ç¬¦ä¸²å­—æ®µ
- å¦‚æœåŒ…å«æ—§åŸŸåï¼Œåˆ™æ›¿æ¢ä¸ºæ–°åŸŸå
- æ”¯æŒç¯å¢ƒå˜é‡å¼•ç”¨

#### 3.4.3 BizIDAdapterï¼ˆä¸šåŠ¡IDé€‚é…å™¨ï¼‰

**ä½œç”¨**ï¼šå¤„ç†ä¸šåŠ¡IDçš„æ˜ å°„å…³ç³»

**é…ç½®æ¨¡å¼**ï¼š

1. **è‡ªåŠ¨æ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼š
```yaml
biz_id_mapping:
  auto: true  # å¯¼å‡ºæ—¶æ ‡è®°ï¼Œå¯¼å…¥æ—¶æ˜ å°„
```

2. **æ‰‹åŠ¨æ˜ å°„æ¨¡å¼**ï¼š
```yaml
biz_id_mapping:
  auto: false
  mapping:
    "100": "200"  # åŸä¸šåŠ¡ID â†’ ç›®æ ‡ä¸šåŠ¡ID
```

3. **æ··åˆæ¨¡å¼**ï¼š
```yaml
biz_id_mapping:
  auto: true
  mapping:
    "100": "200"  # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨æ˜ å°„
```

#### 3.4.4 UserInfoAdapterï¼ˆç”¨æˆ·ä¿¡æ¯é€‚é…å™¨ï¼‰

**ä½œç”¨**ï¼šå¤„ç†ç”¨æˆ·å­—æ®µï¼ˆcreate_user, update_user ç­‰ï¼‰

**ç­–ç•¥**ï¼š
- `keep`ï¼šä¿ç•™åŸå§‹ç”¨æˆ·ï¼ˆé»˜è®¤ï¼‰
- `replace`ï¼šæ›¿æ¢ä¸ºé»˜è®¤ç”¨æˆ·
- `remove`ï¼šæ¸…ç©ºç”¨æˆ·å­—æ®µ

**é…ç½®**ï¼š
```yaml
user_mapping:
  strategy: "replace"  # keep | replace | remove
  default_user: "admin"
```

#### 3.4.5 SensitiveFieldAdapterï¼ˆæ•æ„Ÿå­—æ®µé€‚é…å™¨ï¼‰

**ä½œç”¨**ï¼šå¤„ç†æ•æ„Ÿå­—æ®µï¼ˆå¯†ç ã€å¯†é’¥ç­‰ï¼‰

**ç­–ç•¥**ï¼š
- `keep`ï¼šä¿ç•™åŸå€¼ï¼ˆé»˜è®¤ï¼‰
- `mask`ï¼šé®è”½æ•æ„Ÿå€¼
- `mark`ï¼šæ ‡è®°ä½†ä¿ç•™åŸå€¼

**é…ç½®**ï¼š
```yaml
sensitive_fields_config:
  strategy: "mask"  # keep | mask | mark
  fields: ["token", "password", "secret"]
  mask_value: "***MASKED***"
```

### 3.5 IDMapperï¼ˆIDæ˜ å°„å™¨ï¼‰

**ä½ç½®**ï¼š`scripts/export_utils.py`

**ä½œç”¨**ï¼š
- è®°å½•åŸå§‹IDå’Œèµ„æºç±»å‹çš„æ˜ å°„å…³ç³»
- ä¾¿äºå¯¼å…¥æ—¶é‡å»ºå¯¹è±¡é—´çš„å…³è”å…³ç³»

**æ•°æ®ç»“æ„**ï¼š
```python
{
    "strategy": {
        "100": "original_strategy_100",
        "101": "original_strategy_101"
    },
    "user_group": {
        "200": "original_user_group_200"
    }
}
```

### 3.6 å¯¼å‡ºå™¨å®ç°

æ¯ä¸ªèµ„æºç±»å‹éƒ½æœ‰å¯¹åº”çš„å¯¼å‡ºå™¨ï¼Œç»§æ‰¿è‡ª `BaseExporter`ï¼š

```python
class StrategyExporter(BaseExporter, RelationMixin):
    resource_type = "strategy"
    model_class = StrategyModel
    
    def export_relations(self, obj, data: dict):
        # å¯¼å‡ºå…³è”çš„ Itemã€Detectã€Algorithm
        ...
```

**RelationMixin**ï¼šæä¾›å¯¼å‡ºå…³è”å¯¹è±¡çš„é€šç”¨æ–¹æ³•

---

## é…ç½®ç³»ç»Ÿ

### 4.1 é…ç½®æ–‡ä»¶ç»“æ„

```yaml
# å¯¼å‡ºé…ç½®
export:
  bk_biz_ids: []      # ä¸šåŠ¡IDåˆ—è¡¨
  resources: []       # èµ„æºç±»å‹åˆ—è¡¨
  output_dir: "./export_data"  # è¾“å‡ºç›®å½•

# é€‚é…å™¨é…ç½®
adapters:
  domain_mapping: {}           # åŸŸåæ˜ å°„
  biz_id_mapping: {}           # ä¸šåŠ¡IDæ˜ å°„
  user_mapping: {}             # ç”¨æˆ·ä¿¡æ¯å¤„ç†
  sensitive_fields_config: {}  # æ•æ„Ÿå­—æ®µå¤„ç†
```

### 4.2 é…ç½®åŠ è½½ä¼˜å…ˆçº§

1. å‘½ä»¤è¡Œå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. é…ç½®æ–‡ä»¶
3. é»˜è®¤é…ç½®ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰

### 4.3 è¯¦ç»†é…ç½®è¯´æ˜

å‚è€ƒ `scripts/export_config.example.yaml` æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- æ¯ä¸ªé…ç½®é¡¹çš„è¯¦ç»†è¯´æ˜
- å¤šç§ä½¿ç”¨åœºæ™¯çš„ç¤ºä¾‹
- å‚æ•°è¯´æ˜å’Œæ³¨æ„äº‹é¡¹

---

## ä½¿ç”¨æŒ‡å—

### 5.1 å¿«é€Ÿå¼€å§‹

#### æ–¹å¼1ï¼šä½¿ç”¨ç¤ºä¾‹è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

```bash
cd /path/to/bkmonitor
python manage.py shell < scripts/example_usage.py
```

#### æ–¹å¼2ï¼šä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·

```bash
# å¯¼å‡ºæ‰€æœ‰é…ç½®
python scripts/export_config.py

# å¯¼å‡ºæŒ‡å®šä¸šåŠ¡
python scripts/export_config.py --biz-ids 100,101,102

# å¯¼å‡ºæŒ‡å®šèµ„æºç±»å‹
python scripts/export_config.py --resources strategy,dashboard

# ä½¿ç”¨é…ç½®æ–‡ä»¶
python scripts/export_config.py --config export_config.yaml

# æŸ¥çœ‹æ‰€æœ‰èµ„æºç±»å‹
python scripts/export_config.py --list-resources
```

#### æ–¹å¼3ï¼šåœ¨ä»£ç ä¸­ä½¿ç”¨

```python
from scripts.offshore_migration.export_config import ConfigExporter

# åˆ›å»ºå¯¼å‡ºå™¨
exporter = ConfigExporter(config_file="export_config.yaml")

# æ‰§è¡Œå¯¼å‡º
result = exporter.export_all()

# ä¿å­˜åˆ°æ–‡ä»¶
output_file = exporter.save_to_file()
print(f"å¯¼å‡ºå®Œæˆ: {output_file}")
```

### 5.2 å…¸å‹ä½¿ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šå¯¼å‡ºæ‰€æœ‰ä¸šåŠ¡çš„æ‰€æœ‰é…ç½®

```yaml
export:
  bk_biz_ids: []      # ç©ºåˆ—è¡¨ = æ‰€æœ‰ä¸šåŠ¡
  resources: []       # ç©ºåˆ—è¡¨ = æ‰€æœ‰èµ„æº
```

#### åœºæ™¯2ï¼šå¯¼å‡ºæŒ‡å®šä¸šåŠ¡çš„å‘Šè­¦ç­–ç•¥

```yaml
export:
  bk_biz_ids: [100, 101]
  resources: ["strategy"]
```

#### åœºæ™¯3ï¼šè·¨ç¯å¢ƒè¿ç§»ï¼ˆéœ€è¦åŸŸåå’Œä¸šåŠ¡IDæ˜ å°„ï¼‰

```yaml
export:
  bk_biz_ids: [100, 101]
  resources: []

adapters:
  domain_mapping:
    "https://old-domain.com": "https://new-domain.com"
  
  biz_id_mapping:
    auto: true  # å¯¼å…¥æ—¶å†æ˜ å°„
  
  user_mapping:
    strategy: "replace"
    default_user: "admin"
```

### 5.3 å¯¼å‡ºç»“æœæ ¼å¼

```json
{
  "version": "1.0",
  "export_time": 1737269400,
  "source_env": "production",
  "resources": {
    "strategy": [
      {
        "id": 100,
        "name": "CPUå‘Šè­¦ç­–ç•¥",
        "bk_biz_id": 100,
        "_biz_id_mapping_required": true,
        "_relations": {
          "items": [...],
          "detects": [...]
        }
      }
    ],
    "dashboard": [...]
  },
  "metadata": {
    "id_mappings": {...},
    "adapters_applied": [...]
  }
}
```

---

## æ•°æ®æµç¨‹

### 6.1 å®Œæ•´å¯¼å‡ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŠ è½½é…ç½®                                               â”‚
â”‚    - è¯»å– YAML/JSON é…ç½®æ–‡ä»¶                              â”‚
â”‚    - è§£æå‘½ä»¤è¡Œå‚æ•°                                       â”‚
â”‚    - åˆå¹¶é»˜è®¤é…ç½®                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆå§‹åŒ–ç»„ä»¶                                             â”‚
â”‚    - AdapterManager: åˆå§‹åŒ–é€‚é…å™¨                        â”‚
â”‚    - IDMapper: åˆå§‹åŒ–IDæ˜ å°„å™¨                             â”‚
â”‚    - æ ¹æ®é…ç½®å¯ç”¨/ç¦ç”¨é€‚é…å™¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æŒ‰é¡ºåºå¯¼å‡ºèµ„æº                                         â”‚
â”‚    - æ ¹æ® EXPORT_ORDER ç¡®å®šå¯¼å‡ºé¡ºåº                      â”‚
â”‚    - éå†æ¯ä¸ªèµ„æºç±»å‹                                     â”‚
â”‚    - åˆ›å»ºå¯¹åº”çš„å¯¼å‡ºå™¨å®ä¾‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æŸ¥è¯¢å¯¹è±¡    â”‚   â”‚ 5. å¯¼å‡ºå¯¹è±¡     â”‚
â”‚ - æŒ‰ä¸šåŠ¡IDè¿‡æ»¤ â”‚   â”‚ - è½¬æ¢ä¸ºå­—å…¸     â”‚
â”‚ - åº”ç”¨è¿‡æ»¤æ¡ä»¶ â”‚   â”‚ - å¯¼å‡ºå…³è”æ•°æ®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åº”ç”¨é€‚é…å™¨                                             â”‚
â”‚    - TimestampAdapter: datetime â†’ timestamp             â”‚
â”‚    - DomainAdapter: æ›¿æ¢åŸŸå                             â”‚
â”‚    - BizIDAdapter: å¤„ç†ä¸šåŠ¡ID                           â”‚
â”‚    - UserInfoAdapter: å¤„ç†ç”¨æˆ·ä¿¡æ¯                       â”‚
â”‚    - SensitiveFieldAdapter: å¤„ç†æ•æ„Ÿå­—æ®µ                 â”‚
â”‚    - JSONFieldAdapter: é€’å½’å¤„ç†JSONå­—æ®µ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è®°å½•IDæ˜ å°„                                             â”‚
â”‚    - è®°å½•åŸå§‹IDå’Œèµ„æºç±»å‹                                 â”‚
â”‚    - ä¿å­˜åˆ° metadata.id_mappings                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ç”Ÿæˆå¯¼å‡ºç»“æœ                                           â”‚
â”‚    - åˆå¹¶æ‰€æœ‰èµ„æºæ•°æ®                                     â”‚
â”‚    - æ·»åŠ å…ƒæ•°æ®ï¼ˆç‰ˆæœ¬ã€æ—¶é—´ã€ç¯å¢ƒç­‰ï¼‰                      â”‚
â”‚    - åºåˆ—åŒ–ä¸ºJSON                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ä¿å­˜åˆ°æ–‡ä»¶                                             â”‚
â”‚    - åˆ›å»ºè¾“å‡ºç›®å½•                                         â”‚
â”‚    - ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰                               â”‚
â”‚    - å†™å…¥JSONæ–‡ä»¶                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ•°æ®è½¬æ¢æµç¨‹

```
Django Model
    â”‚
    â”œâ”€â†’ model_to_dict() â†’ Python Dict
    â”‚
    â”œâ”€â†’ export_relations() â†’ æ·»åŠ å…³è”æ•°æ®
    â”‚
    â”œâ”€â†’ AdapterManager.apply_adapters() â†’ åº”ç”¨é€‚é…å™¨
    â”‚   â”‚
    â”‚   â”œâ”€â†’ TimestampAdapter â†’ datetime â†’ int
    â”‚   â”œâ”€â†’ DomainAdapter â†’ æ›¿æ¢åŸŸå
    â”‚   â”œâ”€â†’ BizIDAdapter â†’ å¤„ç†ä¸šåŠ¡ID
    â”‚   â”œâ”€â†’ UserInfoAdapter â†’ å¤„ç†ç”¨æˆ·
    â”‚   â”œâ”€â†’ SensitiveFieldAdapter â†’ å¤„ç†æ•æ„Ÿå­—æ®µ
    â”‚   â””â”€â†’ JSONFieldAdapter â†’ é€’å½’å¤„ç†
    â”‚
    â””â”€â†’ safe_json_dumps() â†’ JSON String
```

### 6.3 ä¾èµ–å…³ç³»å¤„ç†

å¯¼å‡ºé¡ºåºç”± `EXPORT_ORDER` å®šä¹‰ï¼š

```python
EXPORT_ORDER = [
    "duty_rule",          # 1. è½®å€¼è§„åˆ™ï¼ˆæœ€åŸºç¡€ï¼‰
    "user_group",         # 2. å‘Šè­¦ç»„ï¼ˆä¾èµ–è½®å€¼è§„åˆ™ï¼‰
    "action_plugin",      # 3. åŠ¨ä½œæ’ä»¶
    "action_config",      # 4. å¤„ç†å¥—é¤ï¼ˆä¾èµ–æ’ä»¶ï¼‰
    "strategy",           # 5. å‘Šè­¦ç­–ç•¥ï¼ˆä¾èµ–å‘Šè­¦ç»„ã€å¤„ç†å¥—é¤ï¼‰
    "alert_assign_group", # 6. å‘Šè­¦åˆ†æ´¾ï¼ˆä¾èµ–ç­–ç•¥ï¼‰
    "shield",             # 7. å‘Šè­¦å±è”½ï¼ˆä¾èµ–ç­–ç•¥ï¼‰
    "dashboard",          # 8. ä»ªè¡¨ç›˜
    "collector_plugin",  # 9. é‡‡é›†æ’ä»¶
    "collect_config",     # 10. é‡‡é›†é…ç½®ï¼ˆä¾èµ–æ’ä»¶ï¼‰
    "custom_ts_group",    # 11. è‡ªå®šä¹‰æ—¶åºåˆ†ç»„
    "custom_ts_table",    # 12. è‡ªå®šä¹‰æ—¶åºè¡¨ï¼ˆä¾èµ–åˆ†ç»„ï¼‰
]
```

---

## æ‰©å±•å¼€å‘

### 7.1 æ·»åŠ æ–°çš„èµ„æºå¯¼å‡ºå™¨

#### æ­¥éª¤1ï¼šåˆ›å»ºå¯¼å‡ºå™¨ç±»

```python
# scripts/exporters.py

class MyResourceExporter(BaseExporter):
    """
    æˆ‘çš„èµ„æºå¯¼å‡ºå™¨
    """
    resource_type = "my_resource"
    model_class = MyResourceModel
    exclude_fields = ["is_deleted"]
    
    def query_objects(self, bk_biz_ids=None):
        """è‡ªå®šä¹‰æŸ¥è¯¢é€»è¾‘"""
        queryset = self.model_class.objects.all()
        if bk_biz_ids:
            queryset = queryset.filter(bk_biz_id__in=bk_biz_ids)
        return queryset
    
    def export_relations(self, obj, data: dict):
        """å¯¼å‡ºå…³è”æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰"""
        # å¯¼å‡ºå…³è”å¯¹è±¡
        related_objects = RelatedModel.objects.filter(resource_id=obj.id)
        data["_relations"] = {
            "related": self.export_related_queryset(related_objects, "related")
        }
        return data
```

#### æ­¥éª¤2ï¼šæ³¨å†Œå¯¼å‡ºå™¨

```python
# scripts/exporters.py

EXPORTER_REGISTRY = {
    # ... ç°æœ‰å¯¼å‡ºå™¨
    "my_resource": MyResourceExporter,
}
```

#### æ­¥éª¤3ï¼šæ·»åŠ åˆ°å¯¼å‡ºé¡ºåºï¼ˆå¦‚æœéœ€è¦ï¼‰

```python
# scripts/export_utils.py

EXPORT_ORDER = [
    # ... ç°æœ‰é¡ºåº
    "my_resource",  # æ·»åŠ åˆ°åˆé€‚çš„ä½ç½®
]
```

### 7.2 æ·»åŠ æ–°çš„é€‚é…å™¨

#### æ­¥éª¤1ï¼šåˆ›å»ºé€‚é…å™¨ç±»

```python
# scripts/export_adapters.py

class MyCustomAdapter(BaseAdapter):
    """
    è‡ªå®šä¹‰é€‚é…å™¨
    """
    
    def __init__(self, config: dict):
        super().__init__(config)
        self.my_config = config.get("my_adapter_config", {})
    
    def adapt(self, data: Any) -> Any:
        """
        é€‚é…æ•°æ®
        """
        def process_value(value):
            # è‡ªå®šä¹‰å¤„ç†é€»è¾‘
            if isinstance(value, str):
                # å¤„ç†å­—ç¬¦ä¸²
                value = value.replace("old", "new")
            return value
        
        return recursive_process(data, process_value)
```

#### æ­¥éª¤2ï¼šåœ¨ AdapterManager ä¸­å¯ç”¨

```python
# scripts/export_adapters.py

class AdapterManager:
    def _initialize_adapters(self) -> list:
        adapters = [TimestampAdapter(...)]
        
        # æ·»åŠ è‡ªå®šä¹‰é€‚é…å™¨
        if self.config.get("adapters", {}).get("my_adapter_config"):
            adapters.append(MyCustomAdapter(adapters_config))
        
        return adapters
```

#### æ­¥éª¤3ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨

```yaml
adapters:
  my_adapter_config:
    # è‡ªå®šä¹‰é…ç½®é¡¹
    option1: "value1"
```
---

## æœ€ä½³å®è·µ

### 8.1 é…ç½®ç®¡ç†

1. **ä½¿ç”¨é…ç½®æ–‡ä»¶**ï¼šä¸è¦ç¡¬ç¼–ç é…ç½®ï¼Œä½¿ç”¨ YAML æ–‡ä»¶
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°†é…ç½®æ–‡ä»¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶
3. **ç¯å¢ƒåˆ†ç¦»**ï¼šä¸ºä¸åŒç¯å¢ƒå‡†å¤‡ä¸åŒçš„é…ç½®æ–‡ä»¶
4. **æ•æ„Ÿä¿¡æ¯**ï¼šæ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡

### 8.2 å¯¼å‡ºç­–ç•¥

1. **åˆ†é˜¶æ®µå¯¼å‡º**ï¼šå…ˆå¯¼å‡ºåŸºç¡€èµ„æºï¼Œå†å¯¼å‡ºä¾èµ–èµ„æº
2. **å¢é‡å¯¼å‡º**ï¼šåªå¯¼å‡ºå˜æ›´çš„èµ„æºï¼Œå‡å°‘æ•°æ®é‡
3. **éªŒè¯å¯¼å‡º**ï¼šå¯¼å‡ºåéªŒè¯æ•°æ®å®Œæ•´æ€§
4. **å¤‡ä»½åŸæ•°æ®**ï¼šå¯¼å‡ºå‰å¤‡ä»½åŸå§‹æ•°æ®

### 8.3 æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡æŸ¥è¯¢**ï¼šä½¿ç”¨ `select_related` å’Œ `prefetch_related` å‡å°‘æŸ¥è¯¢æ¬¡æ•°
2. **åˆ†é¡µå¯¼å‡º**ï¼šå¯¹äºå¤§é‡æ•°æ®ï¼Œè€ƒè™‘åˆ†é¡µå¯¼å‡º
3. **å¼‚æ­¥å¤„ç†**ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼Œè€ƒè™‘å¼‚æ­¥å¤„ç†
4. **å‹ç¼©è¾“å‡º**ï¼šå¯¹äºå¤§å‹å¯¼å‡ºï¼Œè€ƒè™‘å‹ç¼©è¾“å‡ºæ–‡ä»¶

### 8.4 é”™è¯¯å¤„ç†

1. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•å¯¼å‡ºè¿‡ç¨‹ä¸­çš„é”™è¯¯
2. **å®¹é”™æœºåˆ¶**ï¼šå•ä¸ªèµ„æºå¯¼å‡ºå¤±è´¥ä¸å½±å“å…¶ä»–èµ„æº
3. **é‡è¯•æœºåˆ¶**ï¼šå¯¹äºä¸´æ—¶é”™è¯¯ï¼Œå®ç°é‡è¯•æœºåˆ¶
4. **é”™è¯¯æŠ¥å‘Š**ï¼šç”Ÿæˆè¯¦ç»†çš„é”™è¯¯æŠ¥å‘Š

### 8.5 æ•°æ®å®‰å…¨

1. **æ•æ„Ÿå­—æ®µå¤„ç†**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æ•æ„Ÿå­—æ®µå¤„ç†ç­–ç•¥
2. **æƒé™æ§åˆ¶**ï¼šç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½æ‰§è¡Œå¯¼å‡º
3. **æ•°æ®åŠ å¯†**ï¼šå¯¹äºæ•æ„Ÿæ•°æ®ï¼Œè€ƒè™‘åŠ å¯†å­˜å‚¨
4. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•å¯¼å‡ºæ“ä½œï¼Œä¾¿äºå®¡è®¡

---

## å¸¸è§é—®é¢˜

### 9.1 å¯¼å‡ºç›¸å…³é—®é¢˜

**Q: å¦‚ä½•åªå¯¼å‡ºç‰¹å®šä¸šåŠ¡çš„é…ç½®ï¼Ÿ**

A: åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `bk_biz_ids`ï¼š
```yaml
export:
  bk_biz_ids: [100, 101, 102]
```

**Q: å¦‚ä½•åªå¯¼å‡ºç‰¹å®šç±»å‹çš„èµ„æºï¼Ÿ**

A: åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `resources`ï¼š
```yaml
export:
  resources: ["strategy", "dashboard"]
```

**Q: å¯¼å‡ºæ–‡ä»¶ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ**

A: é»˜è®¤ä¿å­˜åœ¨ `./export_data/` ç›®å½•ï¼Œæ–‡ä»¶åæ ¼å¼ï¼š`monitor_config_export_YYYYMMDD_HHMMSS.json`

**Q: å¦‚ä½•è‡ªå®šä¹‰è¾“å‡ºæ–‡ä»¶åï¼Ÿ**

A: ä½¿ç”¨ `--output` å‚æ•°æˆ–è°ƒç”¨ `save_to_file(output_file)` æ–¹æ³•ï¼š
```bash
python scripts/export_config.py --output /path/to/output.json
```

### 9.2 é…ç½®ç›¸å…³é—®é¢˜

**Q: `auto: true` å’Œ `auto: false` çš„åŒºåˆ«ï¼Ÿ**

A: 
- `auto: true`ï¼šå¯¼å‡ºæ—¶æ ‡è®°éœ€è¦æ˜ å°„çš„ä¸šåŠ¡IDï¼Œå®é™…æ˜ å°„åœ¨å¯¼å…¥æ—¶è¿›è¡Œï¼ˆæ¨èï¼‰
- `auto: false`ï¼šéœ€è¦æä¾› `mapping` é…ç½®è¿›è¡Œæ‰‹åŠ¨æ˜ å°„

**Q: æ•æ„Ÿå­—æ®µå¤„ç†ç­–ç•¥å¦‚ä½•é€‰æ‹©ï¼Ÿ**

A:
- `keep`ï¼šåŒç¯å¢ƒè¿ç§»æˆ–å¯ä¿¡ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰
- `mask`ï¼šéœ€è¦ä¿æŠ¤æ•æ„Ÿä¿¡æ¯
- `mark`ï¼šéœ€è¦æé†’ä½†ä¿ç•™å€¼

**Q: å¦‚ä½•é…ç½®åŸŸåæ˜ å°„ï¼Ÿ**

A:
```yaml
adapters:
  domain_mapping:
    "https://old-domain.com": "https://new-domain.com"
```

### 9.3 æŠ€æœ¯é—®é¢˜

**Q: å¦‚ä½•å¤„ç† datetime åºåˆ—åŒ–é”™è¯¯ï¼Ÿ**

A: ç³»ç»Ÿå·²è‡ªåŠ¨å¤„ç†ï¼Œ`TimestampAdapter` ä¼šå°† datetime è½¬æ¢ä¸ºæ—¶é—´æˆ³ã€‚

**Q: å¦‚ä½•å¤„ç† Decimal ç±»å‹ï¼Ÿ**

A: ç³»ç»Ÿå·²è‡ªåŠ¨å¤„ç†ï¼Œ`safe_json_dumps` ä¼šå°† Decimal è½¬æ¢ä¸º floatã€‚

**Q: JsonField ä¸­çš„æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ**

A: Django çš„ JsonField ä¼šè‡ªåŠ¨å¤„ç† JSON åºåˆ—åŒ–ï¼Œ`JSONFieldAdapter` ä¼šé€’å½’åº”ç”¨å…¶ä»–é€‚é…å™¨ã€‚

**Q: å¦‚ä½•æŸ¥çœ‹å¯¼å‡ºäº†å“ªäº›èµ„æºï¼Ÿ**

A: æŸ¥çœ‹å¯¼å‡ºç»“æœçš„ `metadata.adapters_applied` å­—æ®µï¼Œæˆ–æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚

### 9.4 æ‰©å±•é—®é¢˜

**Q: å¦‚ä½•æ·»åŠ æ–°çš„èµ„æºç±»å‹ï¼Ÿ**

A: å‚è€ƒ [æ‰©å±•å¼€å‘ - æ·»åŠ æ–°çš„èµ„æºå¯¼å‡ºå™¨](#71-æ·»åŠ æ–°çš„èµ„æºå¯¼å‡ºå™¨)

**Q: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰é€‚é…å™¨ï¼Ÿ**

A: å‚è€ƒ [æ‰©å±•å¼€å‘ - æ·»åŠ æ–°çš„é€‚é…å™¨](#72-æ·»åŠ æ–°çš„é€‚é…å™¨)

**Q: å¦‚ä½•ä¿®æ”¹å¯¼å‡ºé¡ºåºï¼Ÿ**

A: ä¿®æ”¹ `scripts/export_utils.py` ä¸­çš„ `EXPORT_ORDER` åˆ—è¡¨ã€‚

---

## é™„å½•

### A. æ–‡ä»¶ç»“æ„

```
scripts/
â”œâ”€â”€ export_config.py          # ä¸»å¯¼å‡ºè„šæœ¬
â”œâ”€â”€ export_config.example.yaml # é…ç½®ç¤ºä¾‹
â”œâ”€â”€ export_base.py            # åŸºç¡€å¯¼å‡ºå™¨
â”œâ”€â”€ exporters.py              # èµ„æºå¯¼å‡ºå™¨å®ç°
â”œâ”€â”€ export_adapters.py        # æ•°æ®é€‚é…å™¨
â”œâ”€â”€ export_utils.py           # å·¥å…·å‡½æ•°
â”œâ”€â”€ export_validator.py       # æ•°æ®éªŒè¯å™¨
â”œâ”€â”€ example_usage.py          # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ test_export.py            # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ quick_test.py             # å¿«é€Ÿæµ‹è¯•
â”œâ”€â”€ QUICKSTART.md             # å¿«é€Ÿå¼€å§‹æŒ‡å—
â””â”€â”€ EXPORT_FUNCTION_GUIDE.md  # æœ¬æ–‡æ¡£
```

### B. æ ¸å¿ƒç±»å’Œæ–¹æ³•

#### ConfigExporter
- `__init__(config_file, config_dict)`
- `export_all() -> dict`
- `save_to_file(output_file) -> str`

#### BaseExporter
- `query_objects(bk_biz_ids) -> QuerySet`
- `export(bk_biz_ids) -> List[dict]`
- `export_object(obj) -> dict`
- `export_relations(obj, data) -> dict`

#### AdapterManager
- `__init__(config)`
- `apply_adapters(data) -> Any`
- `get_applied_adapter_names() -> List[str]`

#### IDMapper
- `record_id(resource_type, original_id, data)`
- `to_dict() -> dict`

### C. é…ç½®é¡¹é€ŸæŸ¥è¡¨

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|--------|------|
| `export.bk_biz_ids` | List[int] | `[]` | ä¸šåŠ¡IDåˆ—è¡¨ |
| `export.resources` | List[str] | `[]` | èµ„æºç±»å‹åˆ—è¡¨ |
| `export.output_dir` | str | `"./export_data"` | è¾“å‡ºç›®å½• |
| `adapters.domain_mapping` | dict | `{}` | åŸŸåæ˜ å°„ |
| `adapters.biz_id_mapping.auto` | bool | `true` | è‡ªåŠ¨æ˜ å°„æ ‡è®° |
| `adapters.biz_id_mapping.mapping` | dict | `{}` | æ‰‹åŠ¨æ˜ å°„å…³ç³» |
| `adapters.user_mapping.strategy` | str | `"keep"` | ç”¨æˆ·å¤„ç†ç­–ç•¥ |
| `adapters.user_mapping.default_user` | str | `"admin"` | é»˜è®¤ç”¨æˆ· |
| `adapters.sensitive_fields_config.strategy` | str | `"keep"` | æ•æ„Ÿå­—æ®µç­–ç•¥ |
| `adapters.sensitive_fields_config.fields` | List[str] | `["token", "password", ...]` | æ•æ„Ÿå­—æ®µåˆ—è¡¨ |

### D. èµ„æºç±»å‹é€ŸæŸ¥è¡¨

| èµ„æºç±»å‹ | æ¨¡å‹ç±» | å…³è”æ•°æ® | è¯´æ˜ |
|---------|--------|---------|------|
| `strategy` | `StrategyModel` | Item, Detect, Algorithm | å‘Šè­¦ç­–ç•¥ |
| `user_group` | `UserGroup` | DutyArrange, DutyRule | å‘Šè­¦ç»„ |
| `duty_rule` | `DutyRule` | - | è½®å€¼è§„åˆ™ |
| `action_config` | `ActionConfig` | - | å¤„ç†å¥—é¤ |
| `action_plugin` | `ActionPlugin` | - | å“åº”åŠ¨ä½œæ’ä»¶ |
| `alert_assign_group` | `AlertAssignGroup` | AlertAssignRule | å‘Šè­¦åˆ†æ´¾ç»„ |
| `shield` | `Shield` | - | å‘Šè­¦å±è”½ |
| `dashboard` | `Dashboard` | - | ä»ªè¡¨ç›˜ |
| `collect_config` | `CollectConfigMeta` | CollectorPlugin | æ•°æ®é‡‡é›†é…ç½® |
| `collector_plugin` | `CollectorPluginMeta` | - | é‡‡é›†æ’ä»¶ |
| `custom_ts_table` | `CustomTSTable` | CustomTSField | è‡ªå®šä¹‰æ—¶åºè¡¨ |
| `custom_ts_group` | `TimeSeriesGroup` | - | è‡ªå®šä¹‰æ—¶åºåˆ†ç»„ |

### E. å‚è€ƒèµ„æº

- **é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š`scripts/export_config.example.yaml`
- **å¿«é€Ÿå¼€å§‹**ï¼š`scripts/QUICKSTART.md`
- **ä»£ç ç¤ºä¾‹**ï¼š`scripts/example_usage.py`
- **æµ‹è¯•è„šæœ¬**ï¼š`scripts/test_export.py`

### F. æ›´æ–°æ—¥å¿—

- **v1.0** (2025-01-19)
  - åˆå§‹ç‰ˆæœ¬
  - æ”¯æŒ 12 ç§èµ„æºç±»å‹å¯¼å‡º
  - å®ç°æ•°æ®é€‚é…å™¨ç³»ç»Ÿ
  - æ”¯æŒ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
  - å®ç° ID æ˜ å°„ç®¡ç†

---

## æ€»ç»“

æœ¬æ–‡æ¡£å…¨é¢ä»‹ç»äº†ç›‘æ§é…ç½®å¯¼å‡ºåŠŸèƒ½çš„è®¾è®¡ã€å®ç°å’Œä½¿ç”¨æ–¹æ³•ã€‚é€šè¿‡é˜…è¯»æœ¬æ–‡æ¡£ï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… ç†è§£æ•´ä½“æ¶æ„å’Œè®¾è®¡æ€è·¯
2. âœ… æŒæ¡å„ä¸ªç»„ä»¶çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•
3. âœ… å­¦ä¼šé…ç½®å’Œä½¿ç”¨å¯¼å‡ºåŠŸèƒ½
4. âœ… äº†è§£å¦‚ä½•æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½
5. âœ… è§£å†³å¸¸è§é—®é¢˜

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-19  
**ç»´æŠ¤è€…**: è“é²¸ç›‘æ§å›¢é˜Ÿ
