plugin_id: multi_cloud_test_alert
version: 1.0.0
plugin_display_name: 公有云告警测试推送
plugin_type: http_push
summary: 推送公有云监控告警
author: 蓝鲸智云

tags:
  - TENCENT CLOUD
  - GOOGLE CLOUD

ingest_config:
  source_format: json
  multiple_events: true
  events_path: data
  alert_sources:
    - code: TENCENT
      name: 腾讯云
    - code: GOOGLE
      name: 谷歌云
  is_external: true
  collect_type: bk_collector

# 清洗配置
normalization_config:
  - field: alert_name
    expr: PolicyName
  - field: event_id
    expr: AlarmId
  - field: description
    expr: Content
  - field: metric
    expr: MetricsInfo[0].MetricName
  - field: category
    expr: MonitorType
  - field: assignee
    expr: assignee
  - field: status
    expr: "get_field({ALARM: 'ABNORMAL', OK: 'RECOVERED', NO_CONF: 'CLOSED'}, AlarmStatus)"
  - field: target
    expr: "regex_extract(AlarmObject, '((2(5[0-5]|[0-4]\\d))|[0-1]?\\d{1,2})(\\.((2(5[0-5]|[0-4]\\d))|[0-1]?\\d{1,2})){3}') || [AlarmObject] | [0]"
  - field: target_type
    expr: "!regex_extract(AlarmObject, '((2(5[0-5]|[0-4]\\d))|[0-1]?\\d{1,2})(\\.((2(5[0-5]|[0-4]\\d))|[0-1]?\\d{1,2})){3}') || ['HOST'] | get_field({HOST: 'HOST'}, [0])"
  - field: severity
    expr: "1"
  - field: bk_biz_id
    expr: "bk_biz_id || '{{plugin_inst_biz_id}}'"
  - field: tags
    expr: '{"monitor_type":MonitorType, "namespace": Namespace,"region": Region,"alarm_type":AlarmType, "metrics": to_string(MetricsInfo), "policy_id": PolicyId, "alarm_object": AlarmObject}'
  - field: time
    expr: LastOccurTime
  - field: source_time
    expr: FirstOccurTime
  - field: anomaly_time
    expr: FirstOccurTime
  - field: dedupe_md5
    expr: dedupe_md5

clean_configs:
  # 谷歌云的清洗配置
  - rules:
    - key: headers."user-agent"
      value:
        - "Google-Alerts"
      method: eq
      condition: or
    - key: __http_query_params__.source
      value:
        - "google"
      method: eq
      condition: or
    normalization_config:
      - field: alert_name
        expr: incident.policy_name
      - field: event_id
        expr: incident.incident_id
      - field: description
        expr: incident.summary
      - field: metric
        expr: incident.metric.displayName
      - field: category
        expr: category
      - field: assignee
        expr: assignee
      - field: status
        expr: "get_field({OPEN: 'ABNORMAL', open: 'ABNORMAL', CLOSED: 'CLOSED', closed: 'CLOSED'}, incident.state)"
      - field: target
        expr: target
      - field: target_type
        expr: target_type
      - field: severity
        expr: "1"
      - field: bk_biz_id
        expr: "bk_biz_id || '{{plugin_inst_biz_id}}'"
      - field: tags
        expr: "merge({scoping_project_id: incident.scoping_project_id, scoping_project_number: incident.scoping_project_number, observed_value: incident.observed_value, resource: to_string(incident.resource), resource_id: incident.resource_id, resource_display_name: incident.resource_display_name, metric: to_string(incident.metric), policy_user_labels: to_string(incident.policy_user_labels), condition: to_string(incident.condition)}, {system_labels: to_string(incident.metadata.system_labels), user_labels: to_string(incident.metadata.user_labels)})"
      - field: time
        expr: incident.started_at
      - field: anomaly_time
        expr: incident.started_at
  # 腾讯云的清洗配置
  - rules:
    - key: __http_query_params__.source
      value:
        - "tencent"
      method: eq
    normalization_config:
      - field: alert_name
        expr: alarmPolicyInfo.policyName
      - field: event_id
        expr: event_id
      - field: description
        expr: "alarmPolicyInfo.conditions.metricShowName && alarmPolicyInfo.conditions.calcType && alarmPolicyInfo.conditions.calcValue && alarmPolicyInfo.conditions.calcUnit && join(' ', [alarmPolicyInfo.conditions.metricShowName, alarmPolicyInfo.conditions.calcType, alarmPolicyInfo.conditions.calcValue, alarmPolicyInfo.conditions.calcUnit]) || alarmPolicyInfo.conditions.productShowName && alarmPolicyInfo.conditions.eventShowName && join(' ', [alarmPolicyInfo.conditions.productShowName, alarmPolicyInfo.conditions.eventShowName]) || alarmObjInfo.content"
      - field: metric
        expr: alarmPolicyInfo.conditions.metricName
      - field: category
        expr: category
      - field: assignee
        expr: assignee
      - field: status
        expr: "get_field({1: 'ABNORMAL', 0: 'RECOVERED'}, alarmStatus)"
      - field: target
        expr: target
      - field: target_type
        expr: target_type
      - field: severity
        expr: "1"
      - field: bk_biz_id
        expr: "bk_biz_id || '{{plugin_inst_biz_id}}'"
      - field: tags
        expr: "merge({region: alarmObjInfo.region, namespace: alarmObjInfo.namespace, appId: alarmObjInfo.appId, uin: alarmObjInfo.uin, unInstanceId: alarmObjInfo.dimensions.unInstanceId, objId: alarmObjInfo.dimensions.objId, content: alarmObjInfo.content, summary: alarmObjInfo.summary}, {Module: alarmObjInfo.tags.Module, alertname: alarmObjInfo.tags.alertname, tcloud_prometheus_instance_id: alarmObjInfo.tags.tcloud_prometheus_instance_id, tcloud_region_name: alarmObjInfo.tags.tcloud_region_name},{alarm_type: alarmType, policyId: alarmPolicyInfo.policyId})"
      - field: time
        expr: firstOccurTime
      - field: source_time
        expr: firstOccurTime
      - field: anomaly_time
        expr: firstOccurTime
