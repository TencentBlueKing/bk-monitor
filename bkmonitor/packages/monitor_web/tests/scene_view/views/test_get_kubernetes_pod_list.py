# -*- coding: utf-8 -*-
"""
Tencent is pleased to support the open source community by making 蓝鲸智云 - 监控平台 (BlueKing - Monitor) available.
Copyright (C) 2017-2025 Tencent. All rights reserved.
Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://opensource.org/licenses/MIT
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
"""
import pytest

from bkmonitor.utils.kubernetes import translate_timestamp_since
from core.drf_resource import resource
from monitor_web.constants import OVERVIEW_ICON

FILTER = [
    {'id': 'success', 'name': 0, 'status': 'success', 'tips': '正常'},
    {'id': 'failed', 'name': 1, 'status': 'failed', 'tips': '异常'},
    {'id': 'disabled', 'name': 0, 'status': 'disabled', 'tips': '无数据'},
]
DATA = [
    {
        'age': translate_timestamp_since('2022-01-01T00:00:00Z'),
        'bcs_cluster_id': {
            'target': 'blank',
            'url': (
                '?bizId=-3#/k8s?sceneId=kubernetes&dashboardId=cluster&sceneType=detail'
                '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"}]}'
            ),
            'value': 'BCS-K8S-00002',
        },
        'images': ['host/namespace/apisix:latest', 'host/namespace/gateway-discovery:latest'],
        'label_list': [],
        'limit_cpu_usage_ratio': {'label': '2.0%', 'status': 'SUCCESS', 'value': 2.0},
        'limit_memory_usage_ratio': {'label': '4.0%', 'status': 'SUCCESS', 'value': 4.0},
        'monitor_status': {'text': '异常', 'type': 'failed'},
        'name': {'icon': '', 'key': '', 'target': 'null_event', 'url': '', 'value': 'api-gateway-2'},
        'namespace': 'namespace_a',
        'node_ip': {
            'target': 'blank',
            'url': (
                '?bizId=-3#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"ip":"1.1.1.1"}]}'
            ),
            'value': '1.1.1.1',
        },
        'node_name': {
            'target': 'blank',
            'url': (
                '?bizId=-3#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"name":"node-1.1.1.1"}]}'
            ),
            'value': 'node-1.1.1.1',
        },
        'pod_ip': '2.2.2.2',
        'ready': '2/2',
        'request_cpu_usage_ratio': {'label': '1.0%', 'status': 'SUCCESS', 'value': 1.0},
        'request_memory_usage_ratio': {'label': '3.0%', 'status': 'SUCCESS', 'value': 3.0},
        'resource_limits_cpu': '10000m',
        'resource_limits_memory': '9GB',
        'resource_requests_cpu': '0',
        'resource_requests_memory': '1GB',
        'resource_usage_cpu': '30m',
        'resource_usage_disk': '315MB',
        'resource_usage_memory': '788MB',
        'restarts': 10,
        'status': 'Completed',
        'total_container_count': {
            'target': 'blank',
            'url': (
                '?bizId=-3#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=detail'
                '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"pod_name":"api-gateway-2"}]}'
            ),
            'value': 2,
        },
        'workload': 'StatefulSet:api-gateway',
    }
]
SORT = [
    {'id': 'restarts', 'name': '重启次数'},
    {'id': 'request_cpu_usage_ratio', 'name': 'CPU使用率(request)'},
    {'id': 'limit_cpu_usage_ratio', 'name': 'CPU使用率(limit)'},
    {'id': 'request_memory_usage_ratio', 'name': '内存使用率(request)'},
    {'id': 'limit_memory_usage_ratio', 'name': '内存使用率(limit) '},
    {'id': 'resource_usage_cpu', 'name': 'CPU使用量'},
    {'id': 'resource_usage_memory', 'name': '内存使用量'},
    {'id': 'resource_usage_disk', 'name': '磁盘使用量'},
    {'id': 'resource_requests_cpu', 'name': 'cpu request'},
    {'id': 'resource_limits_cpu', 'name': 'cpu limit'},
    {'id': 'resource_requests_memory', 'name': 'memory request'},
    {'id': 'resource_limits_memory', 'name': 'memory limit'},
]


@pytest.mark.django_db(databases=["default", "monitor_api"])
class TestGetKubernetesPodList:
    def test_perform_request(
        self,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [{"bcs_cluster_id": "BCS-K8S-00002"}],
            "bk_biz_id": 100,
        }
        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'Completed', 'value': 'Completed'}],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'BCS-K8S-00002', 'value': 'BCS-K8S-00002'}],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'namespace_a', 'value': 'namespace_a'}],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'number',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [{'id': 'BCS-K8S-00002', 'name': 'BCS-K8S-00002'}],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [{'id': 'namespace_a', 'name': 'namespace_a'}],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [{'id': 'api-gateway-2', 'name': 'api-gateway-2'}],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
            ],
            'data': [
                {
                    'age': translate_timestamp_since('2022-01-01T00:00:00Z'),
                    'bcs_cluster_id': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=cluster&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"}]}'
                        ),
                        'value': 'BCS-K8S-00002',
                    },
                    'images': ['host/namespace/apisix:latest', 'host/namespace/gateway-discovery:latest'],
                    'label_list': [],
                    'limit_cpu_usage_ratio': {'label': '2.0%', 'status': 'SUCCESS', 'value': 2.0},
                    'limit_memory_usage_ratio': {'label': '4.0%', 'status': 'SUCCESS', 'value': 4.0},
                    'monitor_status': {'text': '异常', 'type': 'failed'},
                    'name': {'icon': '', 'key': '', 'target': 'null_event', 'url': '', 'value': 'api-gateway-2'},
                    'namespace': 'namespace_a',
                    'node_ip': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"ip":"1.1.1.1"}]}'
                        ),
                        'value': '1.1.1.1',
                    },
                    'node_name': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"name":"node-1.1.1.1"}]}'
                        ),
                        'value': 'node-1.1.1.1',
                    },
                    'pod_ip': '2.2.2.2',
                    'ready': '2/2',
                    'request_cpu_usage_ratio': {'label': '1.0%', 'status': 'SUCCESS', 'value': 1.0},
                    'request_memory_usage_ratio': {'label': '3.0%', 'status': 'SUCCESS', 'value': 3.0},
                    'resource_limits_cpu': '10000m',
                    'resource_limits_memory': '9GB',
                    'resource_requests_cpu': '0',
                    'resource_requests_memory': '1GB',
                    'resource_usage_cpu': '30m',
                    'resource_usage_disk': '315MB',
                    'resource_usage_memory': '788MB',
                    'restarts': 10,
                    'status': 'Completed',
                    'total_container_count': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=detail'
                            '&queryData={"selectorSearch":['
                            '{"bcs_cluster_id":"BCS-K8S-00002"},'
                            '{"pod_name":"api-gateway-2"}]}'
                        ),
                        'value': 2,
                    },
                    'workload': 'StatefulSet:api-gateway',
                }
            ],
            'filter': FILTER,
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.3%', 'status': 'SUCCESS', 'value': 0.3},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '10000m',
                'resource_limits_memory': '9GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '1GB',
                'resource_usage_cpu': '30m',
                'resource_usage_disk': '315MB',
                'resource_usage_memory': '788MB',
                'restarts': 10,
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 2,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 1,
        }
        assert actual == expect

    def test_perform_request__sort_by_restarts(
        self,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [{"bcs_cluster_id": "BCS-K8S-00002"}],
            "bk_biz_id": 100,
            "sort": "-restarts",
        }
        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'Completed', 'value': 'Completed'}],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'BCS-K8S-00002', 'value': 'BCS-K8S-00002'}],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'namespace_a', 'value': 'namespace_a'}],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [{'id': 'BCS-K8S-00002', 'name': 'BCS-K8S-00002'}],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [{'id': 'namespace_a', 'name': 'namespace_a'}],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [{'id': 'api-gateway-2', 'name': 'api-gateway-2'}],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
            ],
            'data': [
                {
                    'age': translate_timestamp_since('2022-01-01T00:00:00Z'),
                    'bcs_cluster_id': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=cluster&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"}]}'
                        ),
                        'value': 'BCS-K8S-00002',
                    },
                    'images': ['host/namespace/apisix:latest', 'host/namespace/gateway-discovery:latest'],
                    'label_list': [],
                    'limit_cpu_usage_ratio': {'label': '2.0%', 'status': 'SUCCESS', 'value': 2.0},
                    'limit_memory_usage_ratio': {'label': '4.0%', 'status': 'SUCCESS', 'value': 4.0},
                    'monitor_status': {'text': '异常', 'type': 'failed'},
                    'name': {'icon': '', 'key': '', 'target': 'null_event', 'url': '', 'value': 'api-gateway-2'},
                    'namespace': 'namespace_a',
                    'node_ip': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"ip":"1.1.1.1"}]}'
                        ),
                        'value': '1.1.1.1',
                    },
                    'node_name': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":['
                            '{"bcs_cluster_id":"BCS-K8S-00002"},'
                            '{"name":"node-1.1.1.1"}]}'
                        ),
                        'value': 'node-1.1.1.1',
                    },
                    'pod_ip': '2.2.2.2',
                    'ready': '2/2',
                    'request_cpu_usage_ratio': {'label': '1.0%', 'status': 'SUCCESS', 'value': 1.0},
                    'request_memory_usage_ratio': {'label': '3.0%', 'status': 'SUCCESS', 'value': 3.0},
                    'resource_limits_cpu': '10000m',
                    'resource_limits_memory': '9GB',
                    'resource_requests_cpu': '0',
                    'resource_requests_memory': '1GB',
                    'resource_usage_cpu': '30m',
                    'resource_usage_disk': '315MB',
                    'resource_usage_memory': '788MB',
                    'restarts': {'label': 10, 'status': 'SUCCESS', 'value': 100.0},
                    'status': 'Completed',
                    'total_container_count': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=detail'
                            '&queryData={"selectorSearch":['
                            '{"bcs_cluster_id":"BCS-K8S-00002"},{"pod_name":"api-gateway-2"}]}'
                        ),
                        'value': 2,
                    },
                    'workload': 'StatefulSet:api-gateway',
                }
            ],
            'filter': FILTER,
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.3%', 'status': 'SUCCESS', 'value': 0.3},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '10000m',
                'resource_limits_memory': '9GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '1GB',
                'resource_usage_cpu': '30m',
                'resource_usage_disk': '315MB',
                'resource_usage_memory': '788MB',
                'restarts': {'label': 10, 'status': 'SUCCESS', 'value': 100},
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 2,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 1,
        }
        assert actual == expect

    def test_perform_request__sort_by_limit_cpu_usage_ratio(
        self,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [{"bcs_cluster_id": "BCS-K8S-00002"}],
            "bk_biz_id": 100,
            "sort": "-limit_cpu_usage_ratio",
        }
        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'Completed', 'value': 'Completed'}],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'BCS-K8S-00002', 'value': 'BCS-K8S-00002'}],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'namespace_a', 'value': 'namespace_a'}],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'number',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [{'id': 'BCS-K8S-00002', 'name': 'BCS-K8S-00002'}],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [{'id': 'namespace_a', 'name': 'namespace_a'}],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [{'id': 'api-gateway-2', 'name': 'api-gateway-2'}],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
            ],
            'data': [
                {
                    'age': translate_timestamp_since('2022-01-01T00:00:00Z'),
                    'bcs_cluster_id': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=cluster&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"}]}'
                        ),
                        'value': 'BCS-K8S-00002',
                    },
                    'images': ['host/namespace/apisix:latest', 'host/namespace/gateway-discovery:latest'],
                    'label_list': [],
                    'limit_cpu_usage_ratio': {'label': '2.0%', 'status': 'SUCCESS', 'value': 2.0},
                    'limit_memory_usage_ratio': {'label': '4.0%', 'status': 'SUCCESS', 'value': 4.0},
                    'monitor_status': {'text': '异常', 'type': 'failed'},
                    'name': {'icon': '', 'key': '', 'target': 'null_event', 'url': '', 'value': 'api-gateway-2'},
                    'namespace': 'namespace_a',
                    'node_ip': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"ip":"1.1.1.1"}]}'
                        ),
                        'value': '1.1.1.1',
                    },
                    'node_name': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"name":"node-1.1.1.1"}]}'
                        ),
                        'value': 'node-1.1.1.1',
                    },
                    'pod_ip': '2.2.2.2',
                    'ready': '2/2',
                    'request_cpu_usage_ratio': {'label': '1.0%', 'status': 'SUCCESS', 'value': 1.0},
                    'request_memory_usage_ratio': {'label': '3.0%', 'status': 'SUCCESS', 'value': 3.0},
                    'resource_limits_cpu': '10000m',
                    'resource_limits_memory': '9GB',
                    'resource_requests_cpu': '0',
                    'resource_requests_memory': '1GB',
                    'resource_usage_cpu': '30m',
                    'resource_usage_disk': '315MB',
                    'resource_usage_memory': '788MB',
                    'restarts': 10,
                    'status': 'Completed',
                    'total_container_count': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=detail'
                            '&queryData={"selectorSearch":['
                            '{"bcs_cluster_id":"BCS-K8S-00002"},'
                            '{"pod_name":"api-gateway-2"}]}'
                        ),
                        'value': 2,
                    },
                    'workload': 'StatefulSet:api-gateway',
                }
            ],
            'filter': FILTER,
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.3%', 'status': 'SUCCESS', 'value': 0.3},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '10000m',
                'resource_limits_memory': '9GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '1GB',
                'resource_usage_cpu': '30m',
                'resource_usage_disk': '315MB',
                'resource_usage_memory': '788MB',
                'restarts': 10,
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 2,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 1,
        }
        assert actual == expect

    def test_perform_request__sort_by_resource_usage_cpu(
        self,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [{"bcs_cluster_id": "BCS-K8S-00002"}],
            "bk_biz_id": 100,
            "sort": "-resource_usage_cpu",
        }
        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'Completed', 'value': 'Completed'}],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'BCS-K8S-00002', 'value': 'BCS-K8S-00002'}],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'namespace_a', 'value': 'namespace_a'}],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'number',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [{'id': 'BCS-K8S-00002', 'name': 'BCS-K8S-00002'}],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [{'id': 'namespace_a', 'name': 'namespace_a'}],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [{'id': 'api-gateway-2', 'name': 'api-gateway-2'}],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
            ],
            'data': [
                {
                    'age': translate_timestamp_since('2022-01-01T00:00:00Z'),
                    'bcs_cluster_id': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=cluster&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"}]}'
                        ),
                        'value': 'BCS-K8S-00002',
                    },
                    'images': ['host/namespace/apisix:latest', 'host/namespace/gateway-discovery:latest'],
                    'label_list': [],
                    'limit_cpu_usage_ratio': {'label': '2.0%', 'status': 'SUCCESS', 'value': 2.0},
                    'limit_memory_usage_ratio': {'label': '4.0%', 'status': 'SUCCESS', 'value': 4.0},
                    'monitor_status': {'text': '异常', 'type': 'failed'},
                    'name': {'icon': '', 'key': '', 'target': 'null_event', 'url': '', 'value': 'api-gateway-2'},
                    'namespace': 'namespace_a',
                    'node_ip': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"ip":"1.1.1.1"}]}'
                        ),
                        'value': '1.1.1.1',
                    },
                    'node_name': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00002"},{"name":"node-1.1.1.1"}]}'
                        ),
                        'value': 'node-1.1.1.1',
                    },
                    'pod_ip': '2.2.2.2',
                    'ready': '2/2',
                    'request_cpu_usage_ratio': {'label': '1.0%', 'status': 'SUCCESS', 'value': 1.0},
                    'request_memory_usage_ratio': {'label': '3.0%', 'status': 'SUCCESS', 'value': 3.0},
                    'resource_limits_cpu': '10000m',
                    'resource_limits_memory': '9GB',
                    'resource_requests_cpu': '0',
                    'resource_requests_memory': '1GB',
                    'resource_usage_cpu': {'label': '30m', 'status': 'SUCCESS', 'value': 100.0},
                    'resource_usage_disk': '315MB',
                    'resource_usage_memory': '788MB',
                    'restarts': 10,
                    'status': 'Completed',
                    'total_container_count': {
                        'target': 'blank',
                        'url': (
                            '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=detail'
                            '&queryData={"selectorSearch":['
                            '{"bcs_cluster_id":"BCS-K8S-00002"},'
                            '{"pod_name":"api-gateway-2"}]}'
                        ),
                        'value': 2,
                    },
                    'workload': 'StatefulSet:api-gateway',
                }
            ],
            'filter': FILTER,
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.3%', 'status': 'SUCCESS', 'value': 0.3},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '10000m',
                'resource_limits_memory': '9GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '1GB',
                'resource_usage_cpu': {'label': '30m', 'status': 'SUCCESS', 'value': 100},
                'resource_usage_disk': '315MB',
                'resource_usage_memory': '788MB',
                'restarts': 10,
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=100#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 2,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 1,
        }
        assert actual == expect

    def test_perform_request__label_filter_found(
        self,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [
                {"bcs_cluster_id": "BCS-K8S-00000"},
                {"namespace": "bcs-system"},
                {"__label_key_1": ["value_1"]},
                {"__label_key_2": ["value_2"]},
            ],
            "bk_biz_id": 2,
        }
        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [
                        {'text': 'Completed', 'value': 'Completed'},
                        {'text': 'Running', 'value': 'Running'},
                    ],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'BCS-K8S-00000', 'value': 'BCS-K8S-00000'}],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'bcs-system', 'value': 'bcs-system'}],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'number',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [{'id': 'BCS-K8S-00000', 'name': 'BCS-K8S-00000'}],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [{'id': 'bcs-system', 'name': 'bcs-system'}],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [
                        {'id': 'api-gateway-0', 'name': 'api-gateway-0'},
                        {'id': 'api-gateway-1', 'name': 'api-gateway-1'},
                    ],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}, {'id': '2.2.2.2', 'name': '2.2.2.2'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}, {'id': 'Running', 'name': 'Running'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
                {
                    'children': [{'id': 'value_1', 'name': 'value_1'}],
                    'id': '__label_key_1',
                    'multiable': True,
                    'name': 'key_1',
                },
                {
                    'children': [{'id': 'value_2', 'name': 'value_2'}],
                    'id': '__label_key_2',
                    'multiable': True,
                    'name': 'key_2',
                },
            ],
            'data': [
                {
                    'age': translate_timestamp_since('2022-01-01T00:00:00Z'),
                    'bcs_cluster_id': {
                        'target': 'blank',
                        'url': (
                            '?bizId=2#/k8s?sceneId=kubernetes&dashboardId=cluster&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00000"}]}'
                        ),
                        'value': 'BCS-K8S-00000',
                    },
                    'images': ['host/namespace/apisix:latest', 'host/namespace/gateway-discovery:latest'],
                    'label_list': [{'key': 'key_1', 'value': 'value_1'}, {'key': 'key_2', 'value': 'value_2'}],
                    'limit_cpu_usage_ratio': {'label': '2.0%', 'status': 'SUCCESS', 'value': 2.0},
                    'limit_memory_usage_ratio': {'label': '4.0%', 'status': 'SUCCESS', 'value': 4.0},
                    'monitor_status': {'text': '正常', 'type': 'success'},
                    'name': {'icon': '', 'key': '', 'target': 'null_event', 'url': '', 'value': 'api-gateway-0'},
                    'namespace': 'bcs-system',
                    'node_ip': {
                        'target': 'blank',
                        'url': (
                            '?bizId=2#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00000"},{"ip":"2.2.2.2"}]}'
                        ),
                        'value': '2.2.2.2',
                    },
                    'node_name': {
                        'target': 'blank',
                        'url': (
                            '?bizId=2#/k8s?sceneId=kubernetes&dashboardId=node&sceneType=detail'
                            '&queryData={"selectorSearch":[{"bcs_cluster_id":"BCS-K8S-00000"},{"name":"node-2-2-2-2"}]}'
                        ),
                        'value': 'node-2-2-2-2',
                    },
                    'pod_ip': '1.1.1.1',
                    'ready': '2/2',
                    'request_cpu_usage_ratio': {'label': '1.0%', 'status': 'SUCCESS', 'value': 1.0},
                    'request_memory_usage_ratio': {'label': '3.0%', 'status': 'SUCCESS', 'value': 3.0},
                    'resource_limits_cpu': '10000m',
                    'resource_limits_memory': '9GB',
                    'resource_requests_cpu': '0',
                    'resource_requests_memory': '1GB',
                    'resource_usage_cpu': '20m',
                    'resource_usage_disk': '315MB',
                    'resource_usage_memory': '788MB',
                    'restarts': 0,
                    'status': 'Running',
                    'total_container_count': {
                        'target': 'blank',
                        'url': (
                            '?bizId=2#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=detail'
                            '&queryData={"selectorSearch":['
                            '{"bcs_cluster_id":"BCS-K8S-00000"},'
                            '{"pod_name":"api-gateway-0"}]}'
                        ),
                        'value': 2,
                    },
                    'workload': 'StatefulSet:api-gateway',
                }
            ],
            'filter': [
                {'id': 'success', 'name': 1, 'status': 'success', 'tips': '正常'},
                {'id': 'failed', 'name': 0, 'status': 'failed', 'tips': '异常'},
                {'id': 'disabled', 'name': 0, 'status': 'disabled', 'tips': '无数据'},
            ],
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.25%', 'status': 'SUCCESS', 'value': 0.25},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '20000m',
                'resource_limits_memory': '18GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '2GB',
                'resource_usage_cpu': '50m',
                'resource_usage_disk': '630MB',
                'resource_usage_memory': '2GB',
                'restarts': 0,
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=2#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 4,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 1,
        }
        assert actual == expect

    def test_perform_request__label_filter_not_found(
        self,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [
                {"bcs_cluster_id": "BCS-K8S-00000"},
                {"namespace": "bcs-system"},
                {"__label_key_1": ["unknown"]},
            ],
            "bk_biz_id": 2,
        }
        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [
                        {'text': 'Completed', 'value': 'Completed'},
                        {'text': 'Running', 'value': 'Running'},
                    ],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'BCS-K8S-00000', 'value': 'BCS-K8S-00000'}],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [{'text': 'bcs-system', 'value': 'bcs-system'}],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'number',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [{'id': 'BCS-K8S-00000', 'name': 'BCS-K8S-00000'}],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [{'id': 'bcs-system', 'name': 'bcs-system'}],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [
                        {'id': 'api-gateway-0', 'name': 'api-gateway-0'},
                        {'id': 'api-gateway-1', 'name': 'api-gateway-1'},
                    ],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}, {'id': '2.2.2.2', 'name': '2.2.2.2'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}, {'id': 'Running', 'name': 'Running'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
                {
                    'children': [{'id': 'value_1', 'name': 'value_1'}],
                    'id': '__label_key_1',
                    'multiable': True,
                    'name': 'key_1',
                },
                {
                    'children': [{'id': 'value_2', 'name': 'value_2'}],
                    'id': '__label_key_2',
                    'multiable': True,
                    'name': 'key_2',
                },
            ],
            'data': [],
            'filter': [
                {'id': 'success', 'name': 1, 'status': 'success', 'tips': '正常'},
                {'id': 'failed', 'name': 2, 'status': 'failed', 'tips': '异常'},
                {'id': 'disabled', 'name': 0, 'status': 'disabled', 'tips': '无数据'},
            ],
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.25%', 'status': 'SUCCESS', 'value': 0.25},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '20000m',
                'resource_limits_memory': '18GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '2GB',
                'resource_usage_cpu': '50m',
                'resource_usage_disk': '630MB',
                'resource_usage_memory': '2GB',
                'restarts': 0,
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=2#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 4,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 0,
        }
        assert actual == expect

    def test_perform_request__ci_space(
        self,
        monkeypatch_get_space_detail,
        monkeypatch_get_clusters_by_space_uid,
        add_bcs_cluster_item_for_update_and_delete,
        add_bcs_pods,
    ):
        params = {
            "page": 1,
            "page_size": 10,
            "condition_list": [{"bcs_cluster_id": "BCS-K8S-00002"}],
            "bk_biz_id": -3,
        }

        actual = resource.scene_view.get_kubernetes_pod_list(params)
        expect = {
            'columns': [
                {
                    'checked': True,
                    'disabled': True,
                    'id': 'name',
                    'max_width': 300,
                    'min_width': 120,
                    'name': 'Pod名称',
                    'overview_name': '概览',
                    'type': 'link',
                    'width': 248,
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [
                        {'text': 'Completed', 'value': 'Completed'},
                        {'text': 'Running', 'value': 'Running'},
                    ],
                    'filterable': True,
                    'id': 'status',
                    'min_width': 120,
                    'name': '运行状态',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'ready',
                    'min_width': 120,
                    'name': '是否就绪(实例运行数/期望数)',
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [
                        {'text': 'BCS-K8S-00000', 'value': 'BCS-K8S-00000'},
                        {'text': 'BCS-K8S-00002', 'value': 'BCS-K8S-00002'},
                    ],
                    'filterable': True,
                    'id': 'bcs_cluster_id',
                    'min_width': 120,
                    'name': '集群ID',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'filter_list': [
                        {'text': 'bcs-system', 'value': 'bcs-system'},
                        {'text': 'namespace_a', 'value': 'namespace_a'},
                    ],
                    'filterable': True,
                    'id': 'namespace',
                    'min_width': 120,
                    'name': 'NameSpace',
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'total_container_count',
                    'min_width': 120,
                    'name': '容器数量',
                    'type': 'link',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'restarts',
                    'min_width': 120,
                    'name': '重启次数',
                    'sortable': False,
                    'type': 'number',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'monitor_status',
                    'min_width': 120,
                    'name': '采集状态',
                    'type': 'status',
                },
                {'checked': False, 'disabled': False, 'id': 'age', 'min_width': 120, 'name': '存活时间', 'type': 'string'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_cpu_usage_ratio',
                    'min_width': 120,
                    'name': 'CPU使用率(limit)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'request_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(request)',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'header_pre_icon': 'icon-avg',
                    'id': 'limit_memory_usage_ratio',
                    'min_width': 120,
                    'name': '内存使用率(limit) ',
                    'sortable': False,
                    'type': 'progress',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_cpu',
                    'min_width': 120,
                    'name': 'CPU使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_memory',
                    'min_width': 120,
                    'name': '内存使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_usage_disk',
                    'min_width': 120,
                    'name': '磁盘使用量',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_cpu',
                    'min_width': 120,
                    'name': 'cpu request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_cpu',
                    'min_width': 120,
                    'name': 'cpu limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_requests_memory',
                    'min_width': 120,
                    'name': 'memory request',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'resource_limits_memory',
                    'min_width': 120,
                    'name': 'memory limit',
                    'sortable': False,
                    'type': 'string',
                },
                {
                    'checked': True,
                    'disabled': False,
                    'id': 'pod_ip',
                    'min_width': 120,
                    'name': 'Pod IP',
                    'type': 'string',
                },
                {'checked': True, 'disabled': False, 'id': 'node_ip', 'min_width': 120, 'name': '节点IP', 'type': 'link'},
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'node_name',
                    'min_width': 120,
                    'name': '节点名称',
                    'type': 'link',
                },
                {
                    'checked': False,
                    'disabled': False,
                    'id': 'workload',
                    'min_width': 120,
                    'name': '工作负载',
                    'type': 'string',
                },
                {'checked': False, 'disabled': False, 'id': 'label_list', 'min_width': 120, 'name': '标签', 'type': 'kv'},
                {'checked': False, 'disabled': False, 'id': 'images', 'min_width': 120, 'name': '镜像', 'type': 'list'},
            ],
            'condition_list': [
                {
                    'children': [
                        {'id': 'BCS-K8S-00000', 'name': 'BCS-K8S-00000'},
                        {'id': 'BCS-K8S-00002', 'name': 'BCS-K8S-00002'},
                    ],
                    'id': 'bcs_cluster_id',
                    'multiable': False,
                    'name': 'cluster',
                },
                {
                    'children': [
                        {'id': 'bcs-system', 'name': 'bcs-system'},
                        {'id': 'namespace_a', 'name': 'namespace_a'},
                    ],
                    'id': 'namespace',
                    'multiable': False,
                    'name': 'namespace',
                },
                {
                    'children': [
                        {'id': 'api-gateway-0', 'name': 'api-gateway-0'},
                        {'id': 'api-gateway-1', 'name': 'api-gateway-1'},
                        {'id': 'api-gateway-2', 'name': 'api-gateway-2'},
                    ],
                    'id': 'name',
                    'multiable': False,
                    'name': 'name',
                },
                {
                    'children': [{'id': 'StatefulSet', 'name': 'StatefulSet'}],
                    'id': 'workload_type',
                    'multiable': False,
                    'name': 'workload_type',
                },
                {
                    'children': [{'id': 'api-gateway', 'name': 'api-gateway'}],
                    'id': 'workload_name',
                    'multiable': False,
                    'name': 'workload_name',
                },
                {
                    'children': [{'id': '1.1.1.1', 'name': '1.1.1.1'}, {'id': '2.2.2.2', 'name': '2.2.2.2'}],
                    'id': 'node_ip',
                    'multiable': False,
                    'name': 'node_ip',
                },
                {
                    'children': [{'id': 'Completed', 'name': 'Completed'}, {'id': 'Running', 'name': 'Running'}],
                    'id': 'status',
                    'multiable': False,
                    'name': 'status',
                },
                {
                    'children': [{'id': 'value_1', 'name': 'value_1'}],
                    'id': '__label_key_1',
                    'multiable': True,
                    'name': 'key_1',
                },
                {
                    'children': [{'id': 'value_2', 'name': 'value_2'}],
                    'id': '__label_key_2',
                    'multiable': True,
                    'name': 'key_2',
                },
            ],
            'data': DATA,
            'filter': FILTER,
            'overview_data': {
                'age': '',
                'bcs_cluster_id': '',
                'images': '',
                'label_list': '',
                'limit_cpu_usage_ratio': {'label': '0.27%', 'status': 'SUCCESS', 'value': 0.27},
                'limit_memory_usage_ratio': {'label': '8.55%', 'status': 'SUCCESS', 'value': 8.55},
                'monitor_status': '',
                'name': {
                    'icon': OVERVIEW_ICON,
                    'key': '',
                    'target': 'null_event',
                    'url': '',
                    'value': '概览',
                },
                'namespace': '',
                'node_ip': '',
                'node_name': '',
                'pod_ip': '',
                'ready': '',
                'request_cpu_usage_ratio': {'label': '', 'status': 'NODATA', 'value': 0},
                'request_memory_usage_ratio': {'label': '76.98%', 'status': 'SUCCESS', 'value': 76.98},
                'resource_limits_cpu': '30000m',
                'resource_limits_memory': '27GB',
                'resource_requests_cpu': '0',
                'resource_requests_memory': '3GB',
                'resource_usage_cpu': '80m',
                'resource_usage_disk': '946MB',
                'resource_usage_memory': '2GB',
                'restarts': 10,
                'status': '',
                'total_container_count': {
                    'target': 'blank',
                    'url': '?bizId=-3#/k8s?sceneId=kubernetes&dashboardId=container&sceneType=overview',
                    'value': 6,
                },
                'workload': '',
            },
            'sort': SORT,
            'total': 1,
        }
        assert actual == expect
