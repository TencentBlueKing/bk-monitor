import pytest

from api.metadata.default import ListMonitorResultTableResource, ListResultTableResource


@pytest.mark.django_db
class TestPagesize:
    """
    测试分页功能
    """

    def test_pagesize(self, mocker):
        return_value = {
            'count': 1005,
            'info': [
                {
                    'bk_biz_id': 0,
                    'bk_data_id': 1004,
                    'create_time': '2022-03-21 03:13:29',
                    'creator': 'system',
                    'default_storage': 'influxdb',
                    'field_list': [
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '业务ID',
                            'field_name': 'bk_biz_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '采集器云区域ID',
                            'field_name': 'bk_cloud_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'CMDB层级信息',
                            'field_name': 'bk_cmdb_level',
                            'is_config_by_user': True,
                            'option': {'influxdb_disabled': True},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '开发商ID',
                            'field_name': 'bk_supplier_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '单个请求处理量',
                            'field_name': 'bytes_per_req',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'double',
                            'unit': 'bytes/req',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '传输速率',
                            'field_name': 'bytes_per_sec',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'double',
                            'unit': 'bytes/s',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '主机名',
                            'field_name': 'hostname',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'instance_id',
                            'field_name': 'instance_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '采集器IP',
                            'field_name': 'ip',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '请求速率',
                            'field_name': 'req_per_sec',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'double',
                            'unit': '次/s',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '数据上报时间',
                            'field_name': 'time',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'timestamp',
                            'type': 'timestamp',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '总请求数',
                            'field_name': 'total_accesses',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '次',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '请求数',
                            'field_name': 'total_accesses_min',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '次',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '总字节量',
                            'field_name': 'total_kbytes',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': 'Kb',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '传输字节量',
                            'field_name': 'total_kbytes_min',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': 'Kb',
                        },
                    ],
                    'is_custom_table': False,
                    'is_enable': True,
                    'label': 'component',
                    'last_modify_time': '2022-03-21 03:14:24',
                    'last_modify_user': 'system',
                    'option': {},
                    'scheme_type': 'fixed',
                    'source_label': 'bk_monitor',
                    'storage_list': ['influxdb', 'kafka'],
                    'table_id': 'apache.net',
                    'table_name_zh': 'apache.net',
                    'type_label': 'time_series',
                },
                {
                    'bk_biz_id': 0,
                    'bk_data_id': 1004,
                    'create_time': '2022-03-21 03:13:29',
                    'creator': 'system',
                    'default_storage': 'influxdb',
                    'field_list': [
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '业务ID',
                            'field_name': 'bk_biz_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '采集器云区域ID',
                            'field_name': 'bk_cloud_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'CMDB层级信息',
                            'field_name': 'bk_cmdb_level',
                            'is_config_by_user': True,
                            'option': {'influxdb_disabled': True},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '开发商ID',
                            'field_name': 'bk_supplier_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'Closing的worker数',
                            'field_name': 'closing',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'CPU负载',
                            'field_name': 'cpu_load',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'double',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'DNS_lookup的worker数',
                            'field_name': 'dns_lookup',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'finishing状态的worker数',
                            'field_name': 'gracefully_finishing',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '主机名',
                            'field_name': 'hostname',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'idle_cleanup的worker数',
                            'field_name': 'idle_cleanup',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'instance_id',
                            'field_name': 'instance_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '采集器IP',
                            'field_name': 'ip',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'keepalive的worker数',
                            'field_name': 'keepalive',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'Logging的worker数',
                            'field_name': 'logging',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'open_slot的worker数',
                            'field_name': 'open_slot',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '捕获请求连接的worker数',
                            'field_name': 'reading_request',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '发送回复中的worker数',
                            'field_name': 'sending_reply',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '启动中的worker数',
                            'field_name': 'starting_up',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '数据上报时间',
                            'field_name': 'time',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'timestamp',
                            'type': 'timestamp',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '总的worker数',
                            'field_name': 'total_worker',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'waiting的workder数',
                            'field_name': 'waiting',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': '个',
                        },
                    ],
                    'is_custom_table': False,
                    'is_enable': True,
                    'label': 'component',
                    'last_modify_time': '2022-03-21 03:14:24',
                    'last_modify_user': 'system',
                    'option': {},
                    'scheme_type': 'fixed',
                    'source_label': 'bk_monitor',
                    'storage_list': ['influxdb', 'kafka'],
                    'table_id': 'apache.performance',
                    'table_name_zh': 'apache.performance',
                    'type_label': 'time_series',
                },
                {
                    'bk_biz_id': 0,
                    'bk_data_id': 1100002,
                    'create_time': '2022-03-21 03:14:15',
                    'creator': 'system',
                    'default_storage': 'influxdb',
                    'field_list': [
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '业务ID',
                            'field_name': 'bk_biz_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '采集器云区域ID',
                            'field_name': 'bk_cloud_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': 'CMDB层级信息',
                            'field_name': 'bk_cmdb_level',
                            'is_config_by_user': True,
                            'option': {'influxdb_disabled': True},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '开发商ID',
                            'field_name': 'bk_supplier_id',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '子配置错误码',
                            'field_name': 'config_error_code',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'metric',
                            'type': 'int',
                            'unit': 'none',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '采集器IP',
                            'field_name': 'ip',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '名字',
                            'field_name': 'name',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '配置文件的绝对路径',
                            'field_name': 'path',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '任务id\t',
                            'field_name': 'taskid',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'int',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '数据上报时间',
                            'field_name': 'time',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'timestamp',
                            'type': 'timestamp',
                            'unit': '',
                        },
                        {
                            'alias_name': '',
                            'default_value': None,
                            'description': '子配置版本',
                            'field_name': 'version',
                            'is_config_by_user': True,
                            'option': {},
                            'tag': 'dimension',
                            'type': 'string',
                            'unit': '',
                        },
                    ],
                    'is_custom_table': False,
                    'is_enable': True,
                    'label': 'others',
                    'last_modify_time': '2022-03-21 03:14:15',
                    'last_modify_user': 'system',
                    'option': {},
                    'scheme_type': 'fixed',
                    'source_label': 'bk_monitor',
                    'storage_list': ['influxdb'],
                    'table_id': 'beat_monitor.heartbeat_child',
                    'table_name_zh': 'beat_monitor.heartbeat_child',
                    'type_label': 'bk_event',
                },
            ],
        }

        a = mocker.patch("api.metadata.default.ListResultTableResource.perform_request", return_value=return_value)
        result = ListMonitorResultTableResource()()
        # 验证调用次数：先拿一次找到总数，再进行分页
        assert 3 == a.call_count
        # 验证结果
        assert 6 == len(result)
        assert return_value["info"] == result[:3]
        assert return_value["info"] == result[-3:]
        result = ListResultTableResource()()
        assert len(result["info"]) == 3
