{
  "id": "db",
  "type": "overview",
  "mode": "custom",
  "name": "DB",
  "variables": [
    {
      "title": "DB类型",
      "type": "list",
      "targets": [
        {
          "datasource": "list_db_system",
          "dataType": "list",
          "api": "apm_db.listDbSystem",
          "data": {
            "app_name": "$app_name",
            "service_name": "$service_name",
            "group_by_key": "attributes.db.system"
          },
          "fields": {
            "id": "db_system"
          }
        }
      ]
    },
    {
      "title": "DB实例",
      "type": "list",
      "targets": [
        {
          "datasource": "instance_list",
          "dataType": "list",
          "api": "apm_metric.instanceList",
          "data": {
            "app_name": "$app_name",
            "service_name": "$service_name",
            "category": "db"
          },
          "fields": {
            "id": "bk_instance_id"
          }
        }
      ]
    }
  ],
  "panels": [
    {
      "id": 1,
      "title": "请求数",
      "type": "graph",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 8,
        "h": 6
      },
      "targets": [
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "总数量",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": []
              }
            ],
            "unify_query_param": {
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                }
              ]
            }
          }
        }
      ],
      "options": {
        "time_series": {
          "type": "bar"
        }
      }
    },
    {
      "id": 2,
      "title": "错误数",
      "type": "apm-timeseries-chart",
      "gridPos": {
        "x": 8,
        "y": 0,
        "w": 8,
        "h": 6
      },
      "targets": [
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "错误数",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                ],
                "display": true,
                "where": [
                  {
                    "key": "status_code",
                    "method": "eq",
                    "value": [
                      "2"
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": []
              }
            ],
            "unify_query_param": {
              "type": "range",
              "stack": "all",
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "status_code",
                      "method": "eq",
                      "value": [
                        "2"
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                }
              ]
            }
          },
          "yAxisIndex": 0
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "错误率",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "unit": "percentunit",
            "expression": "a / b",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "a"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [
                  {
                    "key": "status_code",
                    "method": "eq",
                    "value": [
                      "2"
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": []
              },
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "b"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [],
                "interval_unit": "s",
                "time_field": null,
                "filter_dict": {
                  "service_name": "$service_name",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": []
              }
            ],
            "unify_query_param": {
              "expression": "a / b",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "a"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [
                    {
                      "key": "status_code",
                      "method": "eq",
                      "value": [
                        "2"
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "$service_name",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                },
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "b"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [],
                  "interval_unit": "s",
                  "time_field": null,
                  "filter_dict": {
                    "service_name": "$service_name",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                }
              ]
            }
          },
          "yAxisIndex": 1
        }
      ],
      "options": {
        "time_series": {
          "type": "bar"
        }
      }
    },
    {
      "id": 3,
      "title": "耗时",
      "gridPos": {
        "x": 16,
        "y": 0,
        "w": 8,
        "h": 6
      },
      "type": "graph",
      "targets": [
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "AVG",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "unit": "ns",
            "expression": "a / b",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_duration_sum",
                    "method": "SUM",
                    "alias": "a"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "increase",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  }
                ]
              },
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_total",
                    "method": "SUM",
                    "alias": "b"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [],
                "interval_unit": "s",
                "time_field": null,
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "increase",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "a / b",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_sum",
                      "method": "SUM",
                      "alias": "a"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "increase",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    }
                  ]
                },
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_total",
                      "method": "SUM",
                      "alias": "b"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [],
                  "interval_unit": "s",
                  "time_field": null,
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "increase",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "P50",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_duration_bucket",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                  "le"
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "rate",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  },
                  {
                    "id": "histogram_quantile",
                    "params": [
                      {
                        "id": "scalar",
                        "value": 0.5
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_bucket",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                    "le"
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "rate",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    },
                    {
                      "id": "histogram_quantile",
                      "params": [
                        {
                          "id": "scalar",
                          "value": 0.5
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "P95",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "table": "${table_id}",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_duration_bucket",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                  "le"
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "rate",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  },
                  {
                    "id": "histogram_quantile",
                    "params": [
                      {
                        "id": "scalar",
                        "value": 0.95
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "table": "${table_id}",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_bucket",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                    "le"
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "rate",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    },
                    {
                      "id": "histogram_quantile",
                      "params": [
                        {
                          "id": "scalar",
                          "value": 0.95
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "P99",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_duration_bucket",
                    "method": "SUM",
                    "alias": "B"
                  }
                ],
                "group_by": [
                  "le"
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "rate",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  },
                  {
                    "id": "histogram_quantile",
                    "params": [
                      {
                        "id": "scalar",
                        "value": 0.99
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "B",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_bucket",
                      "method": "SUM",
                      "alias": "B"
                    }
                  ],
                  "group_by": [
                    "le"
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "rate",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    },
                    {
                      "id": "histogram_quantile",
                      "params": [
                        {
                          "id": "scalar",
                          "value": 0.99
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        }
      ]
    },
    {
      "id": 4,
      "title": "命名语句统计",
      "type": "table-chart",
      "targets": [
        {
          "dataType": "table",
          "api": "apm_db.listDbStatistics",
          "data": {
            "app_name": "$app_name",
            "group_by_key": "attributes.db.statement",
            "metric_list": [
              "request_count",
              "avg_duration",
              "error_request_count",
              "slow_request_count",
              "slow_command_rate"
            ],
            "filter_params": {
              "resource.service.name": "$service_name",
              "span_name": "$endpoint_name",
              "attributes.db.system": "$db_system"
            },
            "component_instance_id": "$bk_instance_id"
          }
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 18,
        "w": 24,
        "h": 17
      },
      "options": {
        "table_chart": {
          "json_viewer_data_key": "data",
          "show_expand": false,
          "query_update_url": true,
          "need_title": true
        }
      }
    },
    {
      "id": 5,
      "title": "命名语句明细",
      "type": "table-chart",
      "targets": [
        {
          "data": {
            "app_name": "$app_name",
            "filter_params": {
              "resource.service.name": "$service_name",
              "span_name": "$endpoint_name",
              "attributes.db.system": "$db_system"
            },
            "component_instance_id": "$bk_instance_id"
          },
          "dataType": "table",
          "api": "apm_db.listDbSpan"
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 35,
        "w": 24,
        "h": 17
      },
      "options": {
        "table_chart": {
          "json_viewer_data_key": "data",
          "show_expand": false,
          "query_update_url": true,
          "need_filters": true,
          "need_title": true
        }
      }
    },
    {
      "id": 6,
      "title": "异常事件",
      "type": "api_message",
      "targets": [
        {
          "data": {
            "app_name": "$app_name",
            "filter_params": {
              "resource.service.name": "$service_name",
              "span_name": "$endpoint_name",
              "attributes.db.system": "$db_system"
            },
            "component_instance_id": "$bk_instance_id",
            "category": "db"
          },
          "dataType": "table",
          "api": "apm_meta.queryExceptionEvent"
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 52,
        "w": 24,
        "h": 18
      },
      "options": {
        "table_chart": {
          "json_viewer_data_key": "data",
          "show_expand": true,
          "query_update_url": true
        }
      }
    }
  ],
  "overview_panels": [
    {
      "id": 1,
      "title": "请求数",
      "type": "graph",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 8,
        "h": 6
      },
      "targets": [
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "总数量",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": []
              }
            ],
            "unify_query_param": {
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                }
              ]
            }
          }
        }
      ],
      "options": {
        "time_series": {
          "type": "bar"
        }
      }
    },
    {
      "id": 2,
      "title": "错误数",
      "type": "apm-timeseries-chart",
      "gridPos": {
        "x": 8,
        "y": 0,
        "w": 8,
        "h": 6
      },
      "targets": [
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "错误数",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                ],
                "display": true,
                "where": [
                  {
                    "key": "status_code",
                    "method": "eq",
                    "value": [
                      "2"
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": []
              }
            ],
            "unify_query_param": {
              "type": "range",
              "stack": "all",
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "status_code",
                      "method": "eq",
                      "value": [
                        "2"
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                }
              ]
            }
          },
          "yAxisIndex": 0,
          "chart_type": "bar"
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "错误率",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "unit": "percentunit",
            "expression": "a / b",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "a"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [
                  {
                    "key": "status_code",
                    "method": "eq",
                    "value": [
                      "2"
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "db_system": "$db_system"
                },
                "functions": []
              },
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_count",
                    "method": "SUM",
                    "alias": "b"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [],
                "interval_unit": "s",
                "time_field": null,
                "filter_dict": {
                  "service_name": "$service_name",
                  "db_system": "$db_system"
                },
                "functions": []
              }
            ],
            "unify_query_param": {
              "expression": "a / b",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "a"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [
                    {
                      "key": "status_code",
                      "method": "eq",
                      "value": [
                        "2"
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "$service_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                },
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_count",
                      "method": "SUM",
                      "alias": "b"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [],
                  "interval_unit": "s",
                  "time_field": null,
                  "filter_dict": {
                    "service_name": "$service_name",
                    "db_system": "$db_system"
                  },
                  "functions": []
                }
              ]
            }
          },
          "yAxisIndex": 1,
          "chart_type": "line"
        }
      ],
      "options": {
        "time_series": {
          "type": "bar"
        }
      }
    },
    {
      "id": 3,
      "title": "耗时",
      "gridPos": {
        "x": 16,
        "y": 0,
        "w": 8,
        "h": 6
      },
      "type": "graph",
      "targets": [
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "AVG",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "unit": "ns",
            "expression": "a / b",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_duration_sum",
                    "method": "SUM",
                    "alias": "a"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "increase",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  }
                ]
              },
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_total",
                    "method": "SUM",
                    "alias": "b"
                  }
                ],
                "table": "${table_id}",
                "data_label": "",
                "index_set_id": null,
                "group_by": [],
                "where": [],
                "interval_unit": "s",
                "time_field": null,
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "increase",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "a / b",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_sum",
                      "method": "SUM",
                      "alias": "a"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "increase",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    }
                  ]
                },
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_total",
                      "method": "SUM",
                      "alias": "b"
                    }
                  ],
                  "table": "${table_id}",
                  "data_label": "",
                  "index_set_id": null,
                  "group_by": [],
                  "where": [],
                  "interval_unit": "s",
                  "time_field": null,
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "increase",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "P50",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_duration_bucket",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                  "le"
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "rate",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  },
                  {
                    "id": "histogram_quantile",
                    "params": [
                      {
                        "id": "scalar",
                        "value": 0.5
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_bucket",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                    "le"
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "rate",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    },
                    {
                      "id": "histogram_quantile",
                      "params": [
                        {
                          "id": "scalar",
                          "value": 0.5
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "P95",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "table": "${table_id}",
                "data_type_label": "time_series",
                "metrics": [
                  {
                    "field": "bk_apm_duration_bucket",
                    "method": "SUM",
                    "alias": "A"
                  }
                ],
                "group_by": [
                  "le"
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "rate",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  },
                  {
                    "id": "histogram_quantile",
                    "params": [
                      {
                        "id": "scalar",
                        "value": 0.95
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "A",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "table": "${table_id}",
                  "data_type_label": "time_series",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_bucket",
                      "method": "SUM",
                      "alias": "A"
                    }
                  ],
                  "group_by": [
                    "le"
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "rate",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    },
                    {
                      "id": "histogram_quantile",
                      "params": [
                        {
                          "id": "scalar",
                          "value": 0.95
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "data_type": "time_series",
          "api": "apm_metric.dynamicUnifyQuery",
          "datasource": "time_series",
          "alias": "P99",
          "data": {
            "app_name": "${app_name}",
            "service_name": "${service_name}",
            "component_instance_id": "$bk_instance_id",
            "query_configs": [
              {
                "data_source_label": "custom",
                "data_type_label": "time_series",
                "table": "${table_id}",
                "metrics": [
                  {
                    "field": "bk_apm_duration_bucket",
                    "method": "SUM",
                    "alias": "B"
                  }
                ],
                "group_by": [
                  "le"
                ],
                "display": true,
                "where": [
                  {
                    "key": "db_system",
                    "method": "neq",
                    "value": [
                      ""
                    ],
                    "condition": "and"
                  }
                ],
                "interval_unit": "s",
                "time_field": "time",
                "filter_dict": {
                  "service_name": "${service_name}",
                  "span_name": "$endpoint_name",
                  "db_system": "$db_system"
                },
                "functions": [
                  {
                    "id": "rate",
                    "params": [
                      {
                        "id": "window",
                        "value": "2m"
                      }
                    ]
                  },
                  {
                    "id": "histogram_quantile",
                    "params": [
                      {
                        "id": "scalar",
                        "value": 0.99
                      }
                    ]
                  }
                ]
              }
            ],
            "unify_query_param": {
              "expression": "B",
              "query_configs": [
                {
                  "data_source_label": "custom",
                  "data_type_label": "time_series",
                  "table": "${table_id}",
                  "metrics": [
                    {
                      "field": "bk_apm_duration_bucket",
                      "method": "SUM",
                      "alias": "B"
                    }
                  ],
                  "group_by": [
                    "le"
                  ],
                  "display": true,
                  "where": [
                    {
                      "key": "db_system",
                      "method": "neq",
                      "value": [
                        ""
                      ],
                      "condition": "and"
                    }
                  ],
                  "interval_unit": "s",
                  "time_field": "time",
                  "filter_dict": {
                    "service_name": "${service_name}",
                    "span_name": "$endpoint_name",
                    "db_system": "$db_system"
                  },
                  "functions": [
                    {
                      "id": "rate",
                      "params": [
                        {
                          "id": "window",
                          "value": "2m"
                        }
                      ]
                    },
                    {
                      "id": "histogram_quantile",
                      "params": [
                        {
                          "id": "scalar",
                          "value": 0.99
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        }
      ]
    },
    {
      "id": 4,
      "title": "命名语句统计",
      "type": "table-chart",
      "targets": [
        {
          "dataType": "table",
          "api": "apm_db.listDbStatistics",
          "data": {
            "app_name": "$app_name",
            "group_by_key": "attributes.db.statement",
            "metric_list": [
              "request_count",
              "avg_duration",
              "error_request_count",
              "slow_request_count",
              "slow_command_rate"
            ],
            "filter_params": {
              "resource.service.name": "$service_name",
              "span_name": "$endpoint_name",
              "attributes.db.system": "$db_system"
            },
            "component_instance_id": "$bk_instance_id"
          }
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 18,
        "w": 24,
        "h": 17
      },
      "options": {
        "table_chart": {
          "json_viewer_data_key": "data",
          "show_expand": false,
          "query_update_url": true,
          "need_title": true
        }
      }
    },
    {
      "id": 5,
      "title": "命名语句明细",
      "type": "table-chart",
      "targets": [
        {
          "data": {
            "app_name": "$app_name",
            "filter_params": {
              "resource.service.name": "$service_name",
              "span_name": "$endpoint_name",
              "attributes.db.system": "$db_system"
            },
            "component_instance_id": "$bk_instance_id"
          },
          "dataType": "table",
          "api": "apm_db.listDbSpan"
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 35,
        "w": 24,
        "h": 17
      },
      "options": {
        "table_chart": {
          "json_viewer_data_key": "data",
          "show_expand": false,
          "query_update_url": true,
          "need_filters": true,
          "need_title": true
        }
      }
    },
    {
      "id": 6,
      "title": "异常事件",
      "type": "api_message",
      "targets": [
        {
          "data": {
            "app_name": "$app_name",
            "filter_params": {
              "resource.service.name": "$service_name",
              "span_name": "$endpoint_name",
              "attributes.db.system": "$db_system"
            },
            "component_instance_id": "$bk_instance_id",
            "category": "db"
          },
          "dataType": "table",
          "api": "apm_meta.queryExceptionEvent"
        }
      ],
      "gridPos": {
        "x": 0,
        "y": 52,
        "w": 24,
        "h": 18
      },
      "options": {
        "table_chart": {
          "json_viewer_data_key": "data",
          "show_expand": true,
          "query_update_url": true
        }
      }
    }
  ],
  "order": [],
  "options": {
    "panel_tool": {
      "method_select": false,
      "compare_select": false,
      "columns_toggle": false,
      "interval_select": false,
      "full_table": true,
      "split_switcher": false
    },
    "selector_panel": {
      "title": "DB",
      "type": "table",
      "options": {
        "selector_list": {
          "status_filter": true,
          "field_sort": true,
          "default_sort_field": "-request_count"
        }
      },
      "targets": [
        {
          "datasource": "endpoint_list",
          "dataType": "table",
          "api": "apm_metric.endpointList",
          "data": {
            "app_name": "$app_name",
            "service_name": "$service_name",
            "filter": "db"
          },
          "fields": {
            "endpoint_name": "endpoint_name",
            "app_name": "app_name",
            "service_name": "service_name"
          }
        }
      ]
    }
  }
}
