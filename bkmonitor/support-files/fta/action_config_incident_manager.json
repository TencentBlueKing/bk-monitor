[
    {
        "id": 7,
        "name": "故障分析SaaS",
        "is_builtin": true,
        "is_deleted": false,
        "is_peripheral": true,
        "plugin_source": "peripheral",
        "plugin_type": "bk_incident",
        "plugin_key": "bk_incident",
        "has_child": true,
        "description": "故障分析SaaS是基于BkFlow，融合了蓝鲸AIDEV能力，提供故障分析服务的一款调度编排类 SaaS 产品。<a href=\"{incident_saas_site_url}\" target=\"_blank\">前往故障分析SaaS</a>\n\n* 在故障分析SaaS中创建一个流程\n\n* 流程里面可以添加各种原子\n\n* 处理套餐中可以上下文传参可以在故障分析SaaS流程中设置为 **全局变量**\n\n",
        "config_schema": {
            "template": {
                "resource_class": "GetTemplateListResource",
                "name": "流程名称",
                "resource_module": "api.bk_incident.default",
                "resource_data": "response[*]",
                "mapping": {
                    "id": "{{id}}",
                    "name": "{{name}}",
                    "url": "{{incident_saas_site_url}}/{{scope_type}}_{{scope_value}}/flow/view/{{id}}"
                }
            },
            "plugin_url": {
                "resource_class": "GetUserProjectDetailResource",
                "resource_module": "api.bk_incident.default",
                "resource_data": "response",
                "mapping": {
                    "url": "{{incident_saas_site_url}}/template/new/{{project_id}}/",
                    "tips": "前往故障分析SaaS"
                }
            },
            "detail": {
                "name": "任务参数",
                "resource_class": "GetTemplateInfoResource",
                "resource_module": "api.bk_incident.default",
                "request_data_mapping": {
                    "bk_template_id": "{{template_id}}"
                },
                "resource_data": "response.pipeline_tree.constants.* | [?show_type == 'show']",
                "mapping": {
                    "key": "{{key}}",
                    "name": "{{name}}",
                    "value": "{{value.default or value or ''}}"
                }
            },
            "content_template_with_url": "故障分析SaaS任务【{{action_name}}】处理{{status_display}}，点击$查看任务详情$",
            "content_template": "故障分析SaaS任务【{{action_name}}】处理{{status_display}}, 请关注！！"
        },
        "backend_config": [
            {
                "function": "create_task",
                "name": "创建故障分析SaaS任务",
                "resource_class": "CreateTaskResource",
                "resource_module": "api.bk_incident.default",
                "inputs": [
                    {
                        "key": "bk_biz_id",
                        "value": "bk_biz_id",
                        "type": "int",
                        "format": "jmespath"
                    },
                    {
                        "key": "template_id",
                        "value": "execute_config.template_id",
                        "type": "int",
                        "format": "jmespath"
                    },
                    {
                        "key": "constants",
                        "value": "execute_config.template_detail_dict",
                        "type": "dict",
                        "format": "jmespath"
                    },
                    {
                        "key": "name",
                        "value": "action_name",
                        "type": "string",
                        "format": "jmespath"
                    }
                ],
                "outputs": [
                    {
                        "key": "task_id",
                        "value": "response.task_id",
                        "format": "jmespath"
                    },
                    {
                        "key": "url",
                        "value": "response.task_url",
                        "format": "jmespath"
                    }
                ],
                "next_function": "start_task",
                "need_insert_log": true,
                "log_template": "成功创建故障分析SaaS任务【{{action_name}}】，点击$查看任务详情$"
            },
            {
                "function": "start_task",
                "name": "启动任务",
                "resource_class": "StartTaskResource",
                "resource_module": "api.bk_incident.default",
                "inputs": [
                    {
                        "key": "task_id",
                        "value": "pre_node_outputs.task_id",
                        "type": "int",
                        "format": "jmespath"
                    },
                    {
                        "key": "bk_biz_id",
                        "value": "bk_biz_id",
                        "type": "int",
                        "format": "jmespath"
                    }
                ],
                "outputs": [],
                "next_function": "schedule"
            },
            {
                "function": "schedule",
                "name": "查询任务结果",
                "resource_class": "GetTaskStatusResource",
                "resource_module": "api.bk_incident.default",
                "inputs": [
                    {
                        "key": "task_id",
                        "value": "pre_node_outputs.task_id",
                        "type": "int",
                        "format": "jmespath"
                    },
                    {
                        "key": "bk_biz_id",
                        "value": "bk_biz_id",
                        "type": "int",
                        "format": "jmespath"
                    }
                ],
                "outputs": [
                    {
                        "key": "task_state",
                        "value": "response.state",
                        "type": "string",
                        "format": "jmespath"
                    }
                ],
                "finished_rule": {
                    "key": "task_state",
                    "method": "in",
                    "value": [
                        "FAILED",
                        "FINISHED",
                        "REVOKED"
                    ]
                },
                "success_rule": {
                    "key": "task_state",
                    "method": "in",
                    "value": [
                        "FINISHED"
                    ]
                },
                "need_schedule": true,
                "schedule_timedelta": 2,
                "next_function": "schedule"
            }
        ]
    }
]