<!--
* Tencent is pleased to support the open source community by making
* 蓝鲸智云PaaS平台 (BlueKing PaaS) available.
*
* Copyright (C) 2021 THL A29 Limited, a Tencent company.  All rights reserved.
*
* 蓝鲸智云PaaS平台 (BlueKing PaaS) is licensed under the MIT License.
*
* License for 蓝鲸智云PaaS平台 (BlueKing PaaS):
*
* ---------------------------------------------------
* Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
* documentation files (the "Software"), to deal in the Software without restriction, including without limitation
* the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
* to permit persons to whom the Software is furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all copies or substantial portions of
* the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
* THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
* CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
* IN THE SOFTWARE.
-->

<template>
  <!-- 设置-日志聚类 -->
  <div
    class="setting-log-cluster"
    v-bkloading="{ isLoading: globalLoading }"
  >
    <bk-form
      ref="validateForm"
      :label-width="200"
      :model="formData"
      form-type="vertical"
    >
      <!-- 聚类字段 -->
      <bk-form-item
        :label="$t('聚类字段')"
        :property="'clustering_fields'"
        :required="true"
        :rules="rules.clustering_fields"
      >
        <div class="setting-item">
          <bk-select
            style="width: 482px"
            v-model="formData.clustering_fields"
            :clearable="false"
            :disabled="!globalEditable"
            data-test-id="LogCluster_div_selectField"
          >
            <bk-option
              v-for="option in clusterField"
              :id="option.id"
              :key="option.id"
              :name="option.name"
            >
            </bk-option>
          </bk-select>
          <span
            v-bk-tooltips="{
              content: $t('只能基于一个字段进行聚类，并且字段是为text的分词类型，默认为log字段'),
              placements: ['right'],
              delay: 300,
            }"
          >
            <span class="bk-icon icon-info"></span>
          </span>
        </div>
      </bk-form-item>

      <div class="setting-item">
        <span class="left-word">{{ $t('忽略数字') }}</span>
        <span style="color: #979ba5">{{ $t('前端忽略所有的数字') }}</span>
      </div>
      <div class="setting-item">
        <span class="left-word">{{ $t('忽略字符') }}</span>
        <span style="color: #979ba5">{{ $t('前端忽略数字和所有的常见符号，只保留日志具体内容') }}</span>
      </div>
      <div class="setting-item">
        <span class="left-word">{{ $t('数据指纹') }}</span>
        <div @click="handleChangeFinger">
          <span
            class="top-middle"
            v-bk-tooltips="$t('暂时未开放聚类关闭功能，如有关闭需求，可联系平台管理员')"
            :disabled="!isShowFingerTips"
          >
            <bk-switcher
              class="left-word"
              v-model="fingerSwitch"
              :disabled="!globalEditable || configData.extra.signature_switch"
              :pre-check="() => false"
              data-test-id="LogCluster_div_isOpenSignature"
              size="large"
              theme="primary"
            >
            </bk-switcher>
          </span>
        </div>
        <bk-alert
          style="width: 800px"
          :title="$t('通过AI学习能力，提取日志的数据指纹实现日志聚类，注意训练时间越久效果越好，存储将增加10%')"
          type="info"
        ></bk-alert>
      </div>

      <!-- 字段长度 -->
      <div class="rule-container">
        <bk-form-item
          :label="$t('最大字段长度')"
          :property="'max_log_length'"
          :rules="rules.max_log_length"
          required
        >
          <div class="setting-item">
            <bk-input
              style="width: 94px"
              v-model="formData.max_log_length"
              :disabled="!globalEditable"
              :max="2000000"
              :min="1"
              :precision="0"
              data-test-id="LogCluster_input_fieldLength"
              type="number"
            ></bk-input>
            <span style="margin-left: 8px">{{ $t('字节') }}</span>
            <span
              v-bk-tooltips="{
                content: $t('聚类字段的最大长度，如果超过这个长度将直接丢弃，设置越大将消耗更多的资源'),
                placements: ['right'],
                delay: 300,
              }"
            >
              <span class="bk-icon icon-info"></span>
            </span>
          </div>
        </bk-form-item>
        <!-- 过滤规则 -->
        <div style="margin-bottom: 40px">
          <p style="height: 32px">{{ $t('过滤规则') }}</p>
          <div class="filter-rule">
            <div
              v-for="(item, index) of formData.filter_rules"
              class="filter-rule filter-rule-item"
              :key="index"
            >
              <bk-select
                v-if="formData.filter_rules.length !== 0 && index !== 0 && item.fields_name !== ''"
                class="icon-box and-or mr-neg1"
                v-model="item.logic_operator"
                :clearable="false"
                :disabled="!globalEditable"
              >
                <bk-option
                  v-for="option in comparedList"
                  :id="option.id"
                  :key="option.id"
                  :name="option.name"
                >
                </bk-option>
              </bk-select>

              <bk-select
                v-if="!isCloseSelect"
                v-model="item.fields_name"
                :class="['min-100 mr-neg1 above', item.fields_name === '' && isFieldsError ? 'rule-error' : '']"
                :clearable="false"
                :disabled="!globalEditable"
                :popover-min-width="150"
                searchable
                @blur="blurFilter"
                @selected="fieldsName => handleFieldChange(fieldsName, index)"
              >
                <bk-option
                  v-for="option in filterSelectList"
                  :id="option.id"
                  :key="option.id"
                  :name="option.name"
                >
                </bk-option>
                <template #extension>
                  <div
                    style="cursor: pointer"
                    @click="handleDeleteSelect(index)"
                  >
                    <i class="bk-icon icon-close-circle"></i>{{ $t('删除') }}
                  </div>
                </template>
              </bk-select>

              <bk-select
                v-if="item.fields_name !== ''"
                style="color: #3a84ff"
                class="icon-box mr-neg1"
                v-model="item.op"
                :clearable="false"
                :disabled="!globalEditable"
                :popover-min-width="100"
              >
                <bk-option
                  v-for="option in conditionList"
                  :id="option.id"
                  :key="option.id"
                  :name="option.name"
                >
                </bk-option>
              </bk-select>

              <div @click="handleInputTag(index)">
                <bk-tag-input
                  v-if="item.fields_name !== ''"
                  v-model="item.value"
                  :class="['mr-neg1 min-100 above', !item.value.length && isFilterRuleError ? 'rule-error' : '']"
                  :content-width="232"
                  :list="item.valueList"
                  :max-data="1"
                  :placeholder="$t('请输入')"
                  trigger="focus"
                  allow-auto-match
                  allow-create
                  @blur="handleValueBlur"
                >
                </bk-tag-input>
              </div>
            </div>
            <button
              v-if="isShowAddFilterIcon"
              class="icon-box"
              :disabled="!globalEditable"
              @click="addFilterRule"
            >
              <i class="bk-icon icon-plus-line"></i>
            </button>
          </div>
        </div>
        <!-- 聚类规则 -->
        <rule-table
          ref="ruleTableRef"
          v-on="$listeners"
          :clean-config="cleanConfig"
          :default-data="defaultData"
          :global-editable="globalEditable"
          :table-str="defaultData.predefined_varibles"
        />

        <bk-form-item>
          <bk-button
            :disabled="!globalEditable"
            :loading="isHandle"
            :title="$t('保存')"
            data-test-id="LogCluster_button_submit"
            theme="primary"
            @click.stop.prevent="handleSubmit"
          >
            {{ $t('保存') }}
          </bk-button>
          <bk-button
            style="margin-left: 8px"
            :disabled="!globalEditable"
            :title="$t('重置')"
            data-test-id="LogCluster_button_reset"
            @click="resetPage"
          >
            {{ $t('重置') }}
          </bk-button>
        </bk-form-item>
      </div>
    </bk-form>
    <!-- 保存dialog -->
    <bk-dialog
      width="360"
      ext-cls="submit-dialog"
      v-model="isShowSubmitDialog"
      :mask-close="false"
      :show-footer="false"
      header-position="left"
    >
      <div class="submit-dialog-container">
        <p class="submit-dialog-title">{{ $t('保存待生效') }}</p>
        <p class="submit-dialog-text">{{ $t('该保存需要1小时生效,请耐心等待') }}</p>
        <bk-button
          class="submit-dialog-btn"
          theme="primary"
          @click="closeKnowDialog"
        >
          {{ $t('我知道了') }}</bk-button
        >
      </div>
    </bk-dialog>
  </div>
</template>

<script>
  import { formatDate } from '@/common/util';

  import { handleTransformToTimestamp } from '../../../components/time-range/utils';
  import RuleTable from './rule-table';

  export default {
    components: {
      RuleTable,
    },
    props: {
      globalEditable: {
        type: Boolean,
        default: true,
      },
      totalFields: {
        type: Array,
        default: () => [],
      },
      indexSetItem: {
        type: Object,
        require: true,
      },
      configData: {
        type: Object,
        require: true,
      },
      cleanConfig: {
        type: Object,
        require: true,
      },
      datePickerValue: {
        // 过滤条件字段可选值关系表
        type: Array,
        required: true,
      },
      retrieveParams: {
        type: Object,
        default: () => ({}),
      },
    },
    data() {
      return {
        clusterField: [], // 聚类字段
        globalLoading: false,
        fingerSwitch: false, // 数据指纹
        isShowAddFilterIcon: true, // 是否显示过滤规则增加按钮
        isShowSubmitDialog: false, // 是否展开保存弹窗
        isHandle: false, // 保存loading
        filterSelectList: [], // 过滤条件选项
        isFilterRuleError: false, // 过滤规则未填警告
        isFieldsError: false, // 未选过滤条件字段警告
        isCloseSelect: false, // 过滤规则下拉框隐藏
        defaultData: {},
        rules: {
          clustering_fields: [
            {
              required: true,
              trigger: 'blur',
            },
          ],
          max_log_length: [
            {
              required: true,
              trigger: 'blur',
            },
          ],
        },
        formData: {
          min_members: 0, // 最小日志数量
          max_dist_list: '', // 敏感度
          predefined_varibles: '', //	预先定义的正则表达式
          delimeter: '', // 分词符
          max_log_length: 1, // 最大日志长度
          is_case_sensitive: 1, // 是否大小写忽略
          clustering_fields: '', // 聚类字段
          filter_rules: [], // 过滤规则
          signature_enable: false,
        },
        conditionList: [
          // 过滤条件对比
          { id: '=', name: '=' },
          { id: '!=', name: '!=' },
          { id: 'LIKE', name: 'LIKE' },
          { id: 'NOT LIKE', name: 'NOT LIKE' },
        ],
        comparedList: [
          { id: 'and', name: 'AND' },
          { id: 'or', name: 'OR' },
        ],
        operateIndex: 0, // 赋值过滤字段的操作的当前下标
        isShowFingerTips: false,
        isActive: false,
      };
    },
    watch: {
      'formData.filter_rules': {
        deep: true,
        handler(val) {
          if (val.length === 0) {
            this.isShowAddFilterIcon = true;
            return;
          }
          if ((val.slice(-1)[0].fields_name !== '' && val.length === 1) || val.slice(-1)[0].value.length > 0) {
            this.isShowAddFilterIcon = true;
          }
          if (val.slice(-1)[0].fields_name === '') {
            this.isShowAddFilterIcon = false;
          }
          this.isFilterRuleError = false;
        },
      },
    },
    mounted() {
      this.initList();
    },
    methods: {
      /**
       * @desc: 数据指纹请求
       * @param { Boolean } isDefault 是否请求默认值
       */
      async requestCluster(isDefault = false) {
        this.globalLoading = true;
        try {
          const params = { index_set_id: this.$route.params.indexId };
          const data = { collector_config_id: this.configID };
          const baseUrl = '/logClustering';
          const requestBehindUrl = isDefault ? '/getDefaultConfig' : '/getConfig';
          const requestUrl = `${baseUrl}${requestBehindUrl}`;
          const res = await this.$http.request(requestUrl, !isDefault && { params, data });
          const {
            collector_config_name_en: collectorConfigNameEn,
            min_members,
            max_dist_list,
            predefined_varibles,
            delimeter,
            max_log_length,
            is_case_sensitive,
            clustering_fields,
            filter_rules: filterRules,
          } = res.data;
          const newFilterRules = filterRules.map(item => ({
            ...(this.totalFields.find(tItem => tItem.field_name === item.fields_name) ?? {}),
            ...item,
            value: [item.value],
          }));
          const assignObj = {
            collector_config_name_en: collectorConfigNameEn || '',
            min_members,
            max_dist_list,
            predefined_varibles,
            delimeter,
            max_log_length,
            is_case_sensitive,
            clustering_fields,
            filter_rules: newFilterRules || [],
          };
          Object.assign(this.formData, assignObj);
          Object.assign(this.defaultData, assignObj);
          // 当前回填的字段如果在聚类字段列表里找不到则赋值为空需要用户重新赋值
          const isHaveFieldsItem = this.clusterField.find(item => item.id === res.data.clustering_fields);
          if (!isHaveFieldsItem) this.formData.clustering_fields = '';
          this.$nextTick(() => {
            const requestFields = this.fieldsKeyStrList();
            this.queryValueList(requestFields);
          });
        } catch (e) {
          console.warn(e);
        } finally {
          this.globalLoading = false;
        }
      },
      initList() {
        const { extra, is_active: isActive } = this.configData;
        this.isActive = isActive;
        const {
          extra: { collector_config_id: configID },
        } = this.cleanConfig;
        this.configID = configID;
        this.fingerSwitch = extra.signature_switch;
        this.isShowFingerTips = extra.signature_switch;
        this.formData.clustering_fields = extra.clustering_fields;
        this.clusterField = this.totalFields
          .filter(item => item.is_analyzed)
          .map(el => {
            const { field_name: id, field_alias: alias } = el;
            return { id, name: alias ? `${id}(${alias})` : id };
          });
        this.filterSelectList = this.totalFields
          .filter(item => !/^__dist/.test(item.field_name) && item.field_type !== '__virtual__')
          .map(el => {
            const { field_name: id, field_alias: alias } = el;
            return { id, name: alias ? `${id}(${alias})` : id };
          });
        // 日志聚类且数据指纹同时打开则不请求默认值
        if (isActive) {
          this.requestCluster(false);
        }
      },
      /**
       * @desc: 数据指纹开关
       */
      handleChangeFinger() {
        if (!this.globalEditable) return;

        if (this.fingerSwitch) {
          this.fingerSwitch = false;
          // this.$bkInfo({
          //   title: this.$t('是否关闭数据指纹'),
          //   confirmFn: () => {
          //     this.fingerSwitch = false;
          //   },
          // });
        } else {
          // 当前如果是计算平台则直接请求 计算平台无configID
          if (this.indexSetItem.scenario_id === 'bkdata') {
            this.fingerSwitch = true;
            this.requestCluster(true);
            return;
          }
          if (!this.configID) {
            this.$bkInfo({
              title: this.$t('当前索引集为非采集项,无法设置数据指纹'),
              confirmFn: () => {},
            });
            return;
          }
          this.fingerSwitch = true;
          this.requestCluster(true);
        }
      },
      addFilterRule() {
        this.formData.filter_rules.push({
          fields_name: '', // 过滤规则字段名
          op: '=', // 过滤规则操作符号
          value: [], // 过滤规则字段值
          logic_operator: 'and',
          valueList: [],
        });
      },
      blurFilter() {
        if (this.formData.filter_rules?.length > 0) {
          this.isFilterRuleError = this.formData.filter_rules.some(el => !el.value.length);
          this.isFieldsError = this.formData.filter_rules.some(el => el.fields_name === '');
        }
      },
      handleSubmit() {
        this.blurFilter();
        this.$refs.validateForm.validate().then(
          () => {
            if (this.isFilterRuleError || this.isFieldsError) return;
            this.isHandle = true;
            const { index_set_id, bk_biz_id } = this.indexSetItem;
            const {
              collector_config_name_en,
              min_members,
              max_dist_list,
              predefined_varibles,
              delimeter,
              max_log_length,
              is_case_sensitive,
              clustering_fields,
              filter_rules,
            } = this.formData;
            const paramsData = {
              collector_config_name_en,
              min_members,
              max_dist_list,
              predefined_varibles,
              delimeter,
              max_log_length,
              is_case_sensitive,
              clustering_fields,
              filter_rules,
            };
            // 获取子组件传来的聚类规则数组base64字符串
            paramsData.predefined_varibles = this.$refs.ruleTableRef.ruleArrToBase64();
            // 过滤规则数组形式转成字符串形式传参
            paramsData.filter_rules = paramsData.filter_rules.map(item => ({
              fields_name: item.fields_name,
              logic_operator: item.logic_operator,
              op: item.op,
              value: item.value?.length ? item.value[0] : '',
            }));
            this.$http
              .request('/logClustering/changeConfig', {
                params: {
                  index_set_id,
                },
                data: {
                  ...paramsData,
                  signature_enable: this.fingerSwitch,
                  collector_config_id: this.configID,
                  index_set_id,
                  bk_biz_id,
                },
              })
              .then(() => {
                this.isShowSubmitDialog = true;
              })
              .finally(() => {
                this.isHandle = false;
              });
          },
          () => {},
        );
      },
      // 字段改变
      handleFieldChange(fieldName, index) {
        const field = this.totalFields.find(item => item.field_name === fieldName) ?? {};
        Object.assign(this.formData.filter_rules[index], {
          ...field,
          value: [],
        });
        const requestFields = this.fieldsKeyStrList();
        this.queryValueList(requestFields);
      },
      async queryValueList(fields = []) {
        if (!fields.length) return;
        const tempList = handleTransformToTimestamp(this.datePickerValue);
        try {
          const res = await this.$http.request('retrieve/getAggsTerms', {
            params: {
              index_set_id: this.$route.params.indexId,
            },
            data: {
              keyword: this.retrieveParams?.keyword ?? '*',
              fields,
              start_time: formatDate(tempList[0] * 1000),
              end_time: formatDate(tempList[1] * 1000),
            },
          });
          this.formData.filter_rules.forEach(item => {
            item.valueList =
              res.data.aggs_items[item.fields_name]?.map(item => ({
                id: item.toString(),
                name: item.toString(),
              })) ?? [];
          });
        } catch (err) {
          this.formData.filter_rules.forEach(item => (item.valueList = []));
        }
      },
      fieldsKeyStrList() {
        const fieldsStrList = this.formData.filter_rules
          .filter(item => item.field_type !== 'text' && item.es_doc_values)
          .map(item => item.fields_name);
        return Array.from(new Set(fieldsStrList));
      },
      /**
       * @desc: 赋值过滤字段的下标
       * @param { Number } index 下标
       */
      handleInputTag(index) {
        this.operateIndex = index;
      },
      handleValueBlur(val) {
        const operateItem = this.formData.filter_rules[this.operateIndex];
        if (!operateItem.value.length && val !== '') {
          operateItem.value.push(val);
        }
      },
      handleDeleteSelect(index) {
        this.formData.filter_rules.splice(index, 1);
        this.isCloseSelect = true;
        // 删除非最后一条过滤规则时隐藏下拉框
        this.$nextTick(() => {
          this.isCloseSelect = false;
        });
      },
      resetPage() {
        this.$emit('reset-page');
      },
      closeKnowDialog() {
        this.isShowSubmitDialog = false;
        this.$emit('update-log-fields');
      },
    },
  };
</script>

<style lang="scss" scoped>
  .setting-log-cluster {
    padding: 0 20px;

    .setting-item {
      display: flex;
      align-items: center;
      margin-bottom: 25px;

      .left-word {
        flex-shrink: 0;
        margin-right: 16px;
        font-size: 14px;
        font-weight: 700;
      }

      .bk-icon {
        margin-left: 8px;
        font-size: 18px;
        color: #979ba5;
      }
    }

    .filter-rule {
      display: flex;
      flex-wrap: wrap;

      .icon-box {
        min-width: 32px;
        height: 32px;
        font-size: 14px;
        line-height: 28px;
        text-align: center;
        cursor: pointer;
        background: #fff;
        border: 1px solid #c4c6cc;

        :deep(.bk-select-name) {
          /* stylelint-disable-next-line declaration-no-important */
          padding: 0 !important;
        }

        .icon-plus-line {
          color: #3a84ff;
        }
      }
    }

    .filter-rule-item {
      margin-bottom: 6px;

      :deep(.bk-select-angle) {
        display: none;
      }

      :deep(.bk-select) {
        border-radius: 0;
      }

      :deep(.bk-form-control) {
        width: 140px;
        border-radius: 0;
      }

      .and-or {
        min-width: 62px;
        font-size: 12px;
        color: #ff9c01;
      }

      .min-100 {
        min-width: 100px;
        max-height: 32px;
      }

      .mr-neg1 {
        position: relative;
        margin-right: -1px;
      }

      .above {
        z-index: 99;
      }
    }

    .rule-error {
      :deep(.bk-tag-input) {
        border-color: #ff5656;
      }

      &.bk-select {
        /* stylelint-disable-next-line declaration-no-important */
        border-color: #ff5656 !important;
      }
    }
  }

  .submit-dialog {
    :deep(.bk-dialog-tool) {
      display: none;
    }

    .submit-dialog-container {
      :deep(.bk-button) {
        margin-left: 100px;
      }

      .submit-dialog-title {
        margin-bottom: 7px;
        font-size: 16px;
        font-weight: 700;
      }

      .submit-dialog-text {
        margin-bottom: 22px;
      }

      :deep(.submit-dialog-btn) {
        margin-left: 224px;
      }
    }
  }
</style>
