
## 附录：详细架构图与数据流图

### A. 整体前端架构图

```mermaid
graph TB
    subgraph "应用入口层"
        MAIN["main.js<br/>应用入口"]
        APP["app.tsx<br/>根组件壳"]
    end

    subgraph "核心基础设施"
        ROUTER["router/index.js<br/>路由系统"]
        STORE["store/index.js<br/>Vuex 状态管理"]
        HTTP["api/index.js<br/>HTTP 请求层"]
        SERVICES["services/index.js<br/>API 服务定义"]
    end

    subgraph "Store 模块"
        RETRIEVE_STORE["retrieve<br/>检索状态"]
        COLLECT_STORE["collect<br/>采集状态"]
        GLOBALS_STORE["globals<br/>全局状态"]
    end

    subgraph "路由模块"
        RETRIEVE_ROUTES["retrieveRoutes<br/>检索模块"]
        MANAGE_ROUTES["manageRoutes<br/>管理模块"]
        DASHBOARD_ROUTES["dashboardRoutes<br/>仪表盘模块"]
        MONITOR_ROUTES["monitorRoutes<br/>监控嵌入模块"]
    end

    subgraph "全局 UI 组件"
        NOTICE["Notice<br/>公告组件"]
        HEADNAV["HeadNav<br/>头部导航"]
        AUTHDIALOG["AuthDialog<br/>鉴权弹窗"]
        GLOBALSETTING["GlobalSettingDialog<br/>全局设置"]
    end

    MAIN --> APP
    MAIN --> ROUTER
    MAIN --> STORE
    APP --> NOTICE
    APP --> HEADNAV
    APP --> AUTHDIALOG
    APP --> GLOBALSETTING
    APP --> |router-view| RETRIEVE_ROUTES
    APP --> |router-view| MANAGE_ROUTES
    APP --> |router-view| DASHBOARD_ROUTES
    APP --> |router-view| MONITOR_ROUTES
    
    STORE --> RETRIEVE_STORE
    STORE --> COLLECT_STORE
    STORE --> GLOBALS_STORE
    
    HTTP --> SERVICES
    STORE --> HTTP
```

---

### B. 应用启动时序图

```mermaid
sequenceDiagram
    participant Browser as 浏览器
    participant Main as main.js
    participant Preload as preload.ts
    participant Store as Vuex Store
    participant HTTP as HTTP Layer
    participant API as Backend API
    participant Router as Vue Router
    participant App as App.tsx

    Browser->>Main: 加载应用
    
    rect rgb(240, 248, 255)
        Note over Main: 1. 初始化全局能力
        Main->>Main: 注册全局组件<br/>(JsonFormatWrapper, LogButton, LogIcon)
        Main->>Main: 注册全局 mixin/plugin<br/>(docsLinkMixin, vue-virtual-scroller)
        Main->>Main: 设置 Vue.prototype<br/>($renderHeader, $xss)
    end

    rect rgb(255, 248, 240)
        Note over Main, API: 2. Preload 阶段 (并行请求)
        Main->>Preload: preload({ http, store })
        
        par 并行请求
            Preload->>API: space/getMySpaceList
            Preload->>API: userInfo/getUsername
            Preload->>API: collect/globals
            Preload->>API: meta/getUserGuide
        end
        
        API-->>Preload: 返回结果
        Preload->>Store: commit(spaceUid, bkBizId, userMeta, globalsData...)
    end

    rect rgb(240, 255, 240)
        Note over Main, App: 3. 创建路由 + 拉取菜单 + 挂载
        Main->>Router: getRouter(spaceUid, bkBizId, externalMenu)
        Main->>Store: dispatch('requestMenuList', spaceUid)
        Store->>API: meta/menu
        API-->>Store: 菜单数据
        Main->>App: new Vue({ router, store, i18n })
        App->>Browser: 渲染应用
    end

    rect rgb(255, 240, 255)
        Note over Main, API: 4. Development 环境额外步骤
        alt isDevelopment
            Main->>API: meta/getEnvConstant
            API-->>Main: 环境常量
            Main->>Main: 写入 window.FEATURE_TOGGLE 等
        end
    end
```

---

### C. 路由守卫执行流程

```mermaid
flowchart TD
    START([路由切换开始]) --> BEFORE_EACH{beforeEach 守卫}
    
    subgraph "beforeEach 处理"
        BEFORE_EACH --> CANCEL_REQ[取消 cancelWhenRouteChange<br/>的请求]
        CANCEL_REQ --> CHECK_RETRIEVE{目标是 retrieve?}
        CHECK_RETRIEVE -->|是| POST_MSG[向 window.parent<br/>postMessage 同步参数]
        CHECK_RETRIEVE -->|否| CHECK_EXTERNAL{外部版?}
        POST_MSG --> CHECK_EXTERNAL
        CHECK_EXTERNAL -->|是| CHECK_WHITELIST{路由在白名单?}
        CHECK_EXTERNAL -->|否| ALLOW[允许访问]
        CHECK_WHITELIST -->|否| REDIRECT[重定向到 retrieve<br/>或 manage]
        CHECK_WHITELIST -->|是| ALLOW
    end
    
    REDIRECT --> AFTER_EACH
    ALLOW --> AFTER_EACH
    
    subgraph "afterEach 处理"
        AFTER_EACH{afterEach 守卫} --> CHECK_EXCEPTION{是 exception 页?}
        CHECK_EXCEPTION -->|否| REPORT_LOG[reportRouteLog 上报]
        CHECK_EXCEPTION -->|是| END_HOOK
        REPORT_LOG --> END_HOOK[守卫结束]
    end
    
    END_HOOK --> RENDER([渲染目标组件])
```

---

### D. Retrieve 检索模块初始化数据流

```mermaid
flowchart TD
    subgraph "URL 解析阶段"
        START([进入 Retrieve 页面]) --> PARSE_URL[updateURLArgs 解析 URL]
        PARSE_URL --> CHECK_INDEX_TYPE{检查索引类型}
        CHECK_INDEX_TYPE -->|index_id| SINGLE["单索引模式<br/>ids=#91;index_id#93;<br/>isUnionIndex=false"]
        CHECK_INDEX_TYPE -->|unionList| UNION["联合索引模式<br/>ids=#91;...#93;<br/>isUnionIndex=true"]
        SINGLE --> COMMIT_STORE
        UNION --> COMMIT_STORE
        COMMIT_STORE[store.commit<br/>updateIndexItem<br/>updateSpace<br/>updateState]
    end

    subgraph "索引集列表加载"
        COMMIT_STORE --> GET_INDEX_LIST[dispatch<br/>retrieve/getIndexSetList]
        GET_INDEX_LIST --> CHECK_EMPTY{列表为空?}
        CHECK_EMPTY -->|是| REDIRECT_UNAUTH[跳转 /un-authorized<br/>?type=indexset]
        CHECK_EMPTY -->|否| PROCESS_TAGS[处理 tags 联合索引<br/>处理无效索引兜底]
    end

    subgraph "字段信息 & 查询执行"
        PROCESS_TAGS --> GET_FIELD_INFO[dispatch<br/>requestIndexSetFieldInfo]
        GET_FIELD_INFO --> EMIT_EVENTS[触发事件]
        EMIT_EVENTS --> TREND_EVENT[RetrieveEvent<br/>TREND_GRAPH_SEARCH]
        EMIT_EVENTS --> FIELD_EVENT[RetrieveEvent<br/>LEFT_FIELD_INFO_UPDATE]
        TREND_EVENT --> CHECK_TAB{tab=origin?}
        FIELD_EVENT --> CHECK_TAB
        CHECK_TAB -->|是| EXEC_QUERY[dispatch<br/>requestIndexSetQuery]
        CHECK_TAB -->|否| SKIP_QUERY[跳过主查询]
    end

    subgraph "收藏夹 & 空间监听"
        EXEC_QUERY --> ON_MOUNTED
        SKIP_QUERY --> ON_MOUNTED
        ON_MOUNTED[onMounted] --> GET_FAVORITE[dispatch<br/>requestFavoriteList]
        ON_MOUNTED --> WATCH_SPACE[watch spaceUid]
        WATCH_SPACE --> RESET_STATE[重置索引状态]
        RESET_STATE --> REFETCH[重新拉取<br/>索引集 + 收藏夹]
        REFETCH --> UPDATE_URL[同步修正 URL query]
    end

    REDIRECT_UNAUTH --> END_FLOW([流程结束])
    GET_FAVORITE --> END_FLOW
    UPDATE_URL --> END_FLOW
```

---

### E. HTTP 请求处理流程

```mermaid
flowchart TD
    subgraph "请求发起"
        START([http.request 调用]) --> BUILD_CONFIG[构建请求配置<br/>url, method, params]
        BUILD_CONFIG --> CHECK_CACHE{fromCache?}
        CHECK_CACHE -->|是| HIT_CACHE{缓存命中?}
        HIT_CACHE -->|是| RETURN_CACHE[返回缓存 Promise]
        HIT_CACHE -->|否| ADD_QUEUE
        CHECK_CACHE -->|否| ADD_QUEUE[加入 RequestQueue]
    end

    subgraph "请求拦截器"
        ADD_QUEUE --> REQ_INTERCEPTOR[Request Interceptor]
        REQ_INTERCEPTOR --> ADD_HEADERS[添加 Headers]
        ADD_HEADERS --> H1[X-Bk-Space-Uid<br/>外部版]
        ADD_HEADERS --> H2[Traceparent<br/>追踪链路]
        ADD_HEADERS --> H3[X-BKLOG-TIMEZONE<br/>时区信息]
    end

    subgraph "响应处理"
        H1 --> SEND_REQ[发送请求]
        H2 --> SEND_REQ
        H3 --> SEND_REQ
        SEND_REQ --> RESP_INTERCEPTOR[Response Interceptor]
        RESP_INTERCEPTOR --> CHECK_BLOB{Blob 类型?}
        CHECK_BLOB -->|是| BLOB_HANDLE[Blob 处理逻辑]
        CHECK_BLOB -->|否| HANDLE_RESP[handleResponse]
    end

    subgraph "错误处理"
        HANDLE_RESP --> CHECK_SUCCESS{请求成功?}
        CHECK_SUCCESS -->|是| RETURN_DATA[返回数据]
        CHECK_SUCCESS -->|否| ERROR_HANDLE{错误类型}
        ERROR_HANDLE -->|401| LOGIN_MODAL[弹出登录框<br/>或跳转登录页]
        ERROR_HANDLE -->|9900403| AUTH_DIALOG[写入 authDialogData<br/>触发鉴权弹窗]
        ERROR_HANDLE -->|其他| CHECK_MSG{catchIsShowMessage?}
        CHECK_MSG -->|是| SHOW_MSG[bkMessage 提示]
        CHECK_MSG -->|否| SILENT[静默处理]
    end

    RETURN_CACHE --> END_FLOW([请求结束])
    RETURN_DATA --> END_FLOW
    LOGIN_MODAL --> END_FLOW
    AUTH_DIALOG --> END_FLOW
    SHOW_MSG --> END_FLOW
    SILENT --> END_FLOW
    BLOB_HANDLE --> END_FLOW
```

---

### F. Vuex Store 状态流转图

```mermaid
flowchart LR
    subgraph "组件层"
        COMP[Vue 组件]
    end

    subgraph "Store Actions"
        direction TB
        A1[requestMenuList]
        A2[requestIndexSetFieldInfo]
        A3[requestIndexSetQuery]
        A4[requestFavoriteList]
    end

    subgraph "Store Mutations"
        direction TB
        M1[updateSpace]
        M2[updateIndexItem]
        M3[updateState]
        M4[SET_MENU_LIST]
    end

    subgraph "Store State"
        direction TB
        S1["spaceUid / bkBizId<br/>空间/业务"]
        S2["indexId / indexItem<br/>索引/检索参数"]
        S3["topMenu / currentMenu<br/>菜单状态"]
        S4["indexFieldInfo<br/>字段信息"]
        S5["indexSetQueryResult<br/>检索结果"]
        S6["globalsData<br/>全局配置"]
    end

    subgraph "HTTP Layer"
        HTTP[http.request]
    end

    subgraph "Backend API"
        API["/api/v1/*"]
    end

    COMP -->|dispatch| A1
    COMP -->|dispatch| A2
    COMP -->|dispatch| A3
    COMP -->|dispatch| A4
    COMP -->|commit| M1
    COMP -->|commit| M2
    COMP -->|commit| M3

    A1 --> HTTP
    A2 --> HTTP
    A3 --> HTTP
    A4 --> HTTP
    HTTP --> API
    API --> HTTP

    A1 -->|commit| M4
    A2 -->|commit| M3
    A3 -->|commit| M3

    M1 --> S1
    M2 --> S2
    M3 --> S4
    M3 --> S5
    M4 --> S3

    S1 -->|mapState| COMP
    S2 -->|mapState| COMP
    S3 -->|mapState| COMP
    S4 -->|mapState| COMP
    S5 -->|mapState| COMP
    S6 -->|mapState| COMP
```

---

### G. 检索模块 API 调用链路图

```mermaid
flowchart TD
    subgraph "Preload 阶段"
        P1[space/getMySpaceList<br/>GET /meta/spaces/mine/]
        P2[userInfo/getUsername]
        P3[collect/globals<br/>GET /meta/globals/]
        P4[meta/getUserGuide<br/>GET /meta/user_guide/]
    end

    subgraph "索引集操作"
        I1[retrieve/getIndexSetList<br/>GET /search/index_set/]
        I2[requestIndexSetFieldInfo]
        I2A[单索引: GET /search/index_set/:id/fields/]
        I2B[联合: unionSearch/unionMapping]
        I3[requestIndexSetQuery]
        I3A[单索引: POST /search/index_set/:id/search/]
        I3B[联合: POST /search/index_set/union_search/]
    end

    subgraph "衍生能力"
        D1[趋势图<br/>POST /search/index_set/:id/aggs/date_histogram/]
        D2[Terms 聚合<br/>POST /search/index_set/:id/aggs/terms/]
        D3[上下文<br/>POST /search/index_set/:id/context/]
        D4[实时日志<br/>POST /search/index_set/:id/tail_f/]
        D5[导出<br/>POST /search/index_set/:id/export/]
    end

    subgraph "分享 & data_id"
        S1[创建分享<br/>POST /share/create_or_update_token/]
        S2[获取分享参数<br/>GET share/get_share_params/]
        S3[data_id 解析<br/>GET /index_set/query_by_dataid/]
    end

    P1 --> I1
    I1 --> I2
    I2 --> I2A
    I2 --> I2B
    I2A --> I3
    I2B --> I3
    I3 --> I3A
    I3 --> I3B
    I3A --> D1
    I3A --> D2
    I3A --> D3
    I3A --> D4
    I3A --> D5
```

---

### H. Manage 管理模块组件结构图

```mermaid
graph TB
    subgraph "管理模块壳"
        MANAGE_INDEX["@/views/manage/index.vue<br/>左侧导航 + 子导航 + 右侧内容"]
    end

    subgraph "日志接入/采集"
        C1["collection-item/list<br/>采集项列表"]
        C2["collection-item/manage/:id<br/>采集项详情"]
        C3["collection-item/{add|edit|field|storage|masking}/:id<br/>接入步骤"]
        C4["log-index-set/list<br/>索引集列表"]
        C5["log-index-set/{manage|edit|masking}/:id<br/>索引集详情"]
    end

    subgraph "客户端日志"
        T1["tgpa-task/list<br/>客户端日志列表"]
        T2["tgpa-task/clean-config<br/>清洗配置"]
    end

    subgraph "其他数据源"
        O1["bk-data-collection<br/>计算平台"]
        O2["es-collection<br/>第三方 ES"]
        O3["custom-report<br/>自定义上报"]
    end

    subgraph "日志清洗"
        CL1["clean-list/list<br/>清洗列表"]
        CL2["clean-templates/list<br/>清洗模板"]
        CL3["log-desensitize/list<br/>脱敏列表"]
    end

    subgraph "日志归档"
        A1["archive-repository<br/>归档仓库"]
        A2["archive-list<br/>归档列表"]
        A3["archive-restore<br/>归档还原"]
    end

    subgraph "日志提取"
        E1["manage-log-extract<br/>提取配置"]
        E2["log-extract-task<br/>提取任务"]
        E3["extract-link-manage<br/>链路管理"]
    end

    subgraph "系统设置"
        S1["es-cluster-manage<br/>ES集群管理"]
        S2["report-manage<br/>订阅管理"]
        S3["collection-track<br/>全链路追踪"]
        S4["manage-data-link-conf<br/>数据链路配置"]
    end

    MANAGE_INDEX --> C1
    MANAGE_INDEX --> C2
    MANAGE_INDEX --> C3
    MANAGE_INDEX --> C4
    MANAGE_INDEX --> C5
    MANAGE_INDEX --> T1
    MANAGE_INDEX --> T2
    MANAGE_INDEX --> O1
    MANAGE_INDEX --> O2
    MANAGE_INDEX --> O3
    MANAGE_INDEX --> CL1
    MANAGE_INDEX --> CL2
    MANAGE_INDEX --> CL3
    MANAGE_INDEX --> A1
    MANAGE_INDEX --> A2
    MANAGE_INDEX --> A3
    MANAGE_INDEX --> E1
    MANAGE_INDEX --> E2
    MANAGE_INDEX --> E3
    MANAGE_INDEX --> S1
    MANAGE_INDEX --> S2
    MANAGE_INDEX --> S3
    MANAGE_INDEX --> S4
```

---

### I. 完整页面请求时序图（以检索页为例）

```mermaid
sequenceDiagram
    participant User as 用户
    participant Browser as 浏览器
    participant Router as Vue Router
    participant RetrieveV3 as Retrieve V3
    participant Store as Vuex Store
    participant HTTP as HTTP Layer
    participant API as Backend API

    User->>Browser: 访问 /retrieve/:indexId

    rect rgb(240, 248, 255)
        Note over Router: 路由守卫
        Browser->>Router: 路由切换
        Router->>HTTP: 取消 cancelWhenRouteChange 请求
        Router->>Router: 检查外部版白名单
        Router->>RetrieveV3: 渲染组件
    end

    rect rgb(255, 248, 240)
        Note over RetrieveV3, API: 初始化数据流
        RetrieveV3->>RetrieveV3: updateURLArgs 解析 URL
        RetrieveV3->>Store: commit(updateIndexItem, updateSpace)
        
        RetrieveV3->>Store: dispatch(getIndexSetList)
        Store->>HTTP: request
        HTTP->>API: GET /search/index_set/
        API-->>HTTP: 索引集列表
        HTTP-->>Store: 返回数据
        Store-->>RetrieveV3: 列表数据
    end

    rect rgb(240, 255, 240)
        Note over RetrieveV3, API: 字段信息 & 查询
        RetrieveV3->>Store: dispatch(requestIndexSetFieldInfo)
        Store->>HTTP: request
        HTTP->>API: GET /search/index_set/:id/fields/
        API-->>HTTP: 字段信息
        HTTP-->>Store: 返回数据
        
        Store-->>RetrieveV3: 触发 TREND_GRAPH_SEARCH
        Store-->>RetrieveV3: 触发 LEFT_FIELD_INFO_UPDATE

        RetrieveV3->>Store: dispatch(requestIndexSetQuery)
        Store->>HTTP: request
        HTTP->>API: POST /search/index_set/:id/search/
        API-->>HTTP: 检索结果
        HTTP-->>Store: 返回数据
        Store-->>RetrieveV3: 渲染结果
    end

    rect rgb(255, 240, 255)
        Note over RetrieveV3, API: 并行请求
        par 趋势图
            RetrieveV3->>API: POST /search/index_set/:id/aggs/date_histogram/
            API-->>RetrieveV3: 趋势数据
        and 收藏夹
            RetrieveV3->>Store: dispatch(requestFavoriteList)
            Store->>API: GET /favorite/getFavoriteByGroupList
            API-->>Store: 收藏夹数据
        end
    end

    RetrieveV3->>User: 页面渲染完成
```

---

### J. API Key 映射查找流程

```mermaid
flowchart LR
    subgraph "代码调用"
        CALL["http.request('meta/menu', {...})"]
    end

    subgraph "services/index.js"
        SERVICES["聚合所有 service 模块"]
    end

    subgraph "services/meta.js"
        META["export const menu = {<br/>  url: '/meta/menu/',<br/>  method: 'get'<br/>}"]
    end

    subgraph "api/index.js"
        API["baseURL: '/api/v1'<br/>+ interceptors<br/>+ cancel/cache 机制"]
    end

    subgraph "实际请求"
        REQ["GET /api/v1/meta/menu/"]
    end

    CALL --> SERVICES
    SERVICES --> META
    META --> API
    API --> REQ
```

---

### K. 分层架构全景图

```mermaid
graph TB
    subgraph "用户交互层"
        USER[用户操作]
    end

    subgraph "视图层 Views"
        V1[Retrieve 检索]
        V2[Manage 管理]
        V3[Dashboard 仪表盘]
        V4[Monitor 监控嵌入]
    end

    subgraph "组件层 Components"
        COMP1[业务组件]
        COMP2[通用组件]
        COMP3[布局组件]
    end

    subgraph "状态管理层 Vuex"
        STORE_ROOT[Root Store]
        STORE_M1[retrieve module]
        STORE_M2[collect module]
        STORE_M3[globals module]
    end

    subgraph "服务层 Services"
        SVC1[meta.js]
        SVC2[retrieve.ts]
        SVC3[collect.js]
        SVC4[dashboard.js]
        SVC5[...]
    end

    subgraph "HTTP 层 API"
        HTTP_CORE[axios instance]
        HTTP_QUEUE[RequestQueue]
        HTTP_CACHE[CachedPromise]
        HTTP_INTERCEPT[Interceptors]
    end

    subgraph "后端 API"
        BACKEND["/api/v1/*"]
    end

    USER --> V1
    USER --> V2
    USER --> V3
    USER --> V4

    V1 --> COMP1
    V2 --> COMP1
    V3 --> COMP1
    V4 --> COMP1
    COMP1 --> COMP2
    COMP1 --> COMP3

    V1 --> STORE_ROOT
    V2 --> STORE_ROOT
    V3 --> STORE_ROOT
    V4 --> STORE_ROOT
    
    STORE_ROOT --> STORE_M1
    STORE_ROOT --> STORE_M2
    STORE_ROOT --> STORE_M3

    STORE_M1 --> SVC1
    STORE_M1 --> SVC2
    STORE_M2 --> SVC3
    STORE_M3 --> SVC1

    SVC1 --> HTTP_CORE
    SVC2 --> HTTP_CORE
    SVC3 --> HTTP_CORE
    SVC4 --> HTTP_CORE
    SVC5 --> HTTP_CORE

    HTTP_CORE --> HTTP_QUEUE
    HTTP_CORE --> HTTP_CACHE
    HTTP_CORE --> HTTP_INTERCEPT

    HTTP_INTERCEPT --> BACKEND
```

---

### L. 空间切换数据流

```mermaid
flowchart TD
    START([用户切换空间]) --> UPDATE_URL[更新 URL query<br/>spaceUid & bizId]
    UPDATE_URL --> STORE_COMMIT[store.commit<br/>updateSpace]
    
    STORE_COMMIT --> WATCH_TRIGGER{触发 watch}
    
    WATCH_TRIGGER --> RESET_INDEX[重置索引集状态<br/>indexId = null]
    RESET_INDEX --> RESET_UNION["重置联合索引状态<br/>unionList = #91;#93;"]
    
    RESET_UNION --> PARALLEL_FETCH{并行请求}
    
    PARALLEL_FETCH --> FETCH_MENU[dispatch<br/>requestMenuList]
    PARALLEL_FETCH --> FETCH_INDEX[dispatch<br/>getIndexSetList]
    PARALLEL_FETCH --> FETCH_FAV[dispatch<br/>requestFavoriteList]
    
    FETCH_MENU --> CHECK_DEFAULT{有默认索引?}
    FETCH_INDEX --> CHECK_DEFAULT
    FETCH_FAV --> UPDATE_FAV[更新收藏夹列表]
    
    CHECK_DEFAULT -->|是| SET_DEFAULT[设置默认索引<br/>重新执行检索]
    CHECK_DEFAULT -->|否| SHOW_EMPTY[显示空状态<br/>引导创建索引集]
    
    SET_DEFAULT --> COMPLETE([空间切换完成])
    SHOW_EMPTY --> COMPLETE
    UPDATE_FAV --> COMPLETE
```